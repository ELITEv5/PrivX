<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PLSX Shield Hash Generator — Official</title>
<script src="./ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,sans-serif;background:#0a0a0a;color:#eee;text-align:center;padding:2rem;max-width:820px;margin:auto}
  h1{color:#8b5cf6;text-shadow:0 0 12px #5c00ff;margin-bottom:.5rem}
  h3{color:#00ffcc}
  button{padding:.7rem 1.2rem;background:#5c00ff;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1rem;margin:.3rem;transition:.2s}
  button:hover{background:#6f14ff}
  input{width:90%;max-width:420px;margin:.4rem 0;padding:.6rem;border-radius:8px;border:none;background:#161616;color:#00ffcc;text-align:center}
  pre{background:#111;color:#00ff99;padding:1rem;border-radius:8px;font-size:.9rem;text-align:left;white-space:pre-wrap;word-break:break-all}
  small{color:#aaa;display:block;margin-top:1rem}
  .instructions{background:#141414;padding:1rem;border-radius:10px;text-align:left;margin-bottom:1.5rem;line-height:1.6em;border-left:5px solid #8b5cf6}
  .section{background:#121212;border-radius:12px;padding:1.5rem;margin:1.5rem 0;border:1px solid #222}
  #unsavedWarning{display:none;background:#ffcc00;color:#000;padding:.8rem;border-radius:8px;margin-bottom:1rem;font-weight:bold}
  .warning-banner{background:#ff3300;color:#fff;padding:1rem;border-radius:10px;margin:1.5rem 0;font-weight:bold}
  .neon-btn{background:#5c00ff;color:#fff;border:none;border-radius:8px;padding:0.6rem 1rem;margin-top:0.4rem;cursor:pointer;font-size:1rem;transition:.2s;box-shadow:0 0 10px rgba(91,0,255,0.4)}
  .neon-btn:hover{background:#6f14ff;box-shadow:0 0 25px rgba(91,0,255,0.6)}
  .wallet-guide{display:none;background:#141414;border:1px solid #222;border-radius:10px;padding:1rem;margin-top:0.8rem;text-align:left;color:#ccc;line-height:1.6em}
  .wallet-guide h4{color:#8b5cf6;margin-bottom:0.6rem;text-shadow:0 0 10px #5c00ff}
</style>
</head>
<body>

<div class="warning-banner">
  OFFICIAL PLSX SHIELD HASH GENERATOR<br>
  Do NOT Use this for any other Shields PLSX ONLY!!<br>
</div>

<h1>PLSX Shield Hash Generator — Official (Fixed)</h1>
<p>This tool runs 100 % locally in your browser. Nothing ever leaves your device.</p>

<div class="instructions">
  <h3>Step-by-Step Guide</h3>
  <ol>
    <li><b>Select your role:</b> Depositor (sender) or Withdrawer (receiver).</li>
    <li><b>Depositor Mode</b> — generates a random Secret and Deposit Hash.<br>
      <ul>
        <li>Secret — keep this private. It unlocks your PLSX.</li>
        <li>Deposit Hash — paste into the PLSX Shield → <b>Step 1: Deposit</b>.</li>
      </ul>
    </li>
    <li><b>Withdrawer Mode</b> — enter the Secret you received + your wallet.<br>
      Generates the <b>Commit Hash</b> for <b>Step 2: Commit</b> in the shield.</li>
  </ol>
  ONE-TIME USE ONLY! Never reuse a Secret.<br>
  <p style="color:#00ffcc;">You can save this file and run it offline for maximum privacy.</p>
</div>

<div class="section">
  <h3>Select Mode</h3>
  <button id="btnDeposit">Deposit Mode</button>
  <button id="btnWithdraw">Withdraw Mode</button>
  <div id="unsavedWarning">You have an unsaved Secret or Hash! Copy or save it before generating a new one.</div>
</div>

<div class="section" id="depositSection" style="display:none;">
  <h3>Deposit Mode</h3>
  <p>Creates a <b>Secret</b> and <b>Deposit Hash</b> for locking PLSX privately.</p>
  <p>Use the <b>Deposit Hash</b> in the PLSX Shield → <b>Step 1: Deposit</b>.</p>
  <button id="generateDeposit">Generate Secret + Deposit Hash</button>
  <button id="copyDeposit" disabled>Copy All</button>
  <button id="saveDeposit" disabled>Save .txt</button>
  <pre id="outputDeposit">Click “Generate” to create your Secret and Deposit Hash.</pre>
  <small>Keep your Secret ultra-private. Losing it = losing your PLSX forever.</small>
</div>

<div class="section" id="withdrawSection" style="display:none;">
  <h3>Withdraw Mode</h3>
  <p>For the receiver who was sent the Secret.</p>
  <p>Paste the Secret + your wallet address → get the Commit Hash.</p>
  <input id="withdrawSecret" placeholder="Paste full Secret here (64-char hex is normal)" />
  <input id="walletInput" placeholder="Your wallet address (0x…)" />
  <button id="showWalletGuide" class="neon-btn">Create / Switch Wallet</button>
  <div id="walletGuide" class="wallet-guide">
    <h4>Creating a Fresh Wallet (Recommended)</h4>
    <ol>
      <li>Open MetaMask / Rabby / etc.</li>
      <li>“Create Account” or “Add Account”</li>
      <li>Copy the new address and paste above</li>
      <li>Use a fresh address every time for best privacy</li>
    </ol>
  </div>
  <small style="color:#ffcc00;display:block;margin-top:.5rem;">Using a previously-seen address reduces privacy.</small>
  <button id="generateWithdraw">Generate Commit Hash</button>
  <button id="copyWithdraw" disabled>Copy Hash</button>
  <button id="saveWithdraw" disabled>Save .txt</button>
  <pre id="outputWithdraw">Paste Secret + wallet, then click “Generate Commit Hash”.</pre>
  <small>Use this Commit Hash in PLSX Shield → Step 2: Commit.</small>
</div>

<script>
let secret="",depositHash="",commitHash="";
const warnBanner=document.getElementById("unsavedWarning");

function showSection(id){
  document.getElementById("depositSection").style.display="none";
  document.getElementById("withdrawSection").style.display="none";
  document.getElementById(id).style.display="block";
}
document.getElementById("btnDeposit").onclick=()=>showSection("depositSection");
document.getElementById("btnWithdraw").onclick=()=>showSection("withdrawSection");

// === DEPOSIT MODE — FIXED (ABI ENCODE) ===
document.getElementById("generateDeposit").onclick=()=>{
  if(typeof ethers==="undefined"){alert("Ethers.js not loaded.");return;}
  if(secret&&depositHash){if(!confirm("You already have an unsaved Secret.\nGenerate a new one?"))return;}
  const bytes=crypto.getRandomValues(new Uint8Array(32));
  secret=Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
  const abi=new ethers.utils.AbiCoder();
  const encoded=abi.encode(["string"],[secret]);
  depositHash=ethers.utils.keccak256(encoded);
  document.getElementById("outputDeposit").textContent=
`Secret (keep private — this unlocks your PLSX):
${secret}

Deposit Hash (paste in PLSX Shield → Step 1):
${depositHash}

Save this now — matches Solidity keccak256(abi.encode(secret)) exactly.`;
  document.getElementById("copyDeposit").disabled=false;
  document.getElementById("saveDeposit").disabled=false;
  warnBanner.style.display="block";
};
// === WITHDRAW MODE — CONTRACT-COMPATIBLE NONCE VERSION ===
document.getElementById("generateWithdraw").onclick = () => {
  if (typeof ethers === "undefined") {
    alert("Ethers.js not loaded.");
    return;
  }
  const s = document.getElementById("withdrawSecret").value.trim();
  const w = document.getElementById("walletInput").value.trim();
  if (!s) {
    alert("Enter the Secret you received.");
    return;
  }
  if (!ethers.utils.isAddress(w)) {
    alert("Valid wallet address required.");
    return;
  }

  // Generate a random nonce
  const nonceBytes = crypto.getRandomValues(new Uint8Array(8));
  const nonce = Array.from(nonceBytes).map(b => b.toString(16).padStart(2, "0")).join("");

  // Combine nonce with secret, so contract still hashes (secret, wallet)
  const combinedSecret = `${s}:${nonce}`;

  // Encode using your contract's expected format
  const abi = new ethers.utils.AbiCoder();
  const encoded = abi.encode(["string", "address"], [combinedSecret, w]);
  commitHash = ethers.utils.keccak256(encoded);

  document.getElementById("outputWithdraw").textContent =
`Commit Hash (paste in PLSX Shield → Step 2):
${commitHash}

Nonce (for uniqueness — part of your secret):
${nonce}

✅ Matches Solidity keccak256(abi.encode(secret, wallet)) exactly
(because nonce is merged into the secret string).`;

  document.getElementById("copyWithdraw").disabled = false;
  document.getElementById("saveWithdraw").disabled = false;
  warnBanner.style.display = "block";
};

// === COPY / SAVE BUTTONS ===
document.getElementById("copyDeposit").onclick=async()=>{
  await navigator.clipboard.writeText(`Secret:\n${secret}\n\nDeposit Hash:\n${depositHash}`);
  alert("Copied to clipboard!");
  warnBanner.style.display="none";
};
document.getElementById("saveDeposit").onclick=()=>{
  const blob=new Blob([`PLSX Shield — Deposit Output\n\nSecret:\n${secret}\n\nDeposit Hash:\n${depositHash}`],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="PLSX-Shield-Deposit.txt";
  a.click();
  warnBanner.style.display="none";
};
document.getElementById("copyWithdraw").onclick=async()=>{
  await navigator.clipboard.writeText(commitHash);
  alert("Commit hash copied!");
  warnBanner.style.display="none";
};
document.getElementById("saveWithdraw").onclick=()=>{
  const blob=new Blob([`PLSX Shield — Commit Hash\n\n${commitHash}`],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="PLSX-Shield-Commit.txt";
  a.click();
  warnBanner.style.display="none";
};

// Wallet helper toggle
document.getElementById("showWalletGuide").onclick=()=>{
  const guide=document.getElementById("walletGuide");
  guide.style.display=guide.style.display==="block"?"none":"block";
};
</script>

<footer style="margin-top:2rem;font-size:.85rem;color:#777;text-align:center;">
  <hr style="border:none;border-top:1px solid #333;margin:1.5rem 0;">
  <p>Official PLSX Proof-of-Privacy Shield Generator • Elite Team6 • 2025<br>
  <a href="https://github.com/ELITEv5/PrivX" target="_blank" style="color:#8b5cf6;">View on GitHub</a></p>
</footer>
</body>
</html>
