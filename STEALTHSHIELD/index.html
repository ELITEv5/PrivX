<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PrivX Stealth Shield V13 — Private Transfers</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f1117; --card:#171a21; --text:#e2e8f0; --muted:#94a3b8; --primary:#a78bfa; --success:#22c55e; --border:#2d3748; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; line-height:1.6; }
  .container { max-width:460px; margin:2rem auto; padding:0 1rem; }
  header { text-align:center; padding:2.5rem 0 1.5rem; }
  header img { height:96px; border-radius:20px; box-shadow:0 10px 40px rgba(167,139,250,0.5); }
  header h1 { font-size:2rem; margin:1rem 0 0.4rem; color:white; font-weight:700; background:linear-gradient(90deg,#a78bfa,#ec4899); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  header p { color:var(--muted); font-size:1.05rem; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.6rem; margin:1.6rem 0; }
  .btn { background:var(--primary); color:white; border:none; border-radius:12px; padding:1rem; width:100%; font-weight:600; cursor:pointer; transition:0.2s; font-size:1.1rem; }
  .btn:hover { background:#8b5cf6; }
  .btn:disabled { background:#334155; cursor:not-allowed; opacity:0.7; }
  .btn-success { background:var(--success); }
  input, textarea { width:100%; padding:1rem; border-radius:12px; border:1px solid var(--border); background:#1e2533; color:white; font-size:1rem; margin:0.6rem 0; box-sizing:border-box; font-family:monospace; }
  .label { display:block; margin:1.4rem 0 0.5rem; font-size:1rem; color:var(--muted); font-weight:500; }
  .critical { background:#7f1d1d; color:#fca5a5; padding:1.2rem; border-radius:12px; margin:1.4rem 0; font-weight:600; text-align:center; font-size:1.05rem; }
  .warning { color:#f59e0b; font-size:0.95rem; margin-top:0.6rem; display:block; }
  .tab { padding:1rem; background:#1e2533; border-radius:12px; cursor:pointer; text-align:center; margin:0.5rem 0; }
  .tab.active { background:var(--primary); color:white; font-weight:600; }
  .highlight { background:#1e4d3d; color:#22c55e; padding:0.8rem; border-radius:8px; margin:1rem 0; font-family:monospace; font-weight:bold; text-align:center; }
  .check-result { background:#1e2533; border-radius:12px; padding:1.2rem; margin-top:1rem; font-size:1rem; line-height:1.8; }
  .check-active { color:#22c55e; font-weight:600; }
  .check-claimed { color:#ef4444; font-weight:600; }
  .check-expired { color:#f59e0b; font-weight:600; }
  .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:1.5rem 0; }
  .stat { background:#1e2533; border-radius:12px; padding:1.2rem; text-align:center; }
  .stat-label { font-size:0.9rem; color:var(--muted); }
  .stat-value { font-size:1.5rem; font-weight:700; color:white; margin-top:0.4rem; }
  footer { text-align:center; padding:2.5rem; color:#475569; font-size:0.9rem; }
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="PRIVX.png" alt="PrivX Shield">
    <h1>PrivX Stealth Shield</h1>
    <p>Private • Instant • Forever</p>
  </header>

  <!-- MODE SELECTOR -->
  <div class="card">
    <div class="label">Mode</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="tab active" id="tabDepositor" onclick="setMode('depositor')">Depositor</div>
      <div class="tab" id="tabReceiver" onclick="setMode('receiver')">Receiver</div>
    </div>
  </div>

  <!-- DEPOSITOR MODE -->
  <div id="depositorSection">
    <div class="card">
      <div class="label">1. Generate Deposit</div>
      <button id="generateDepositBtn" class="btn" disabled>Generate Secret + Hash</button>
      <div id="depositorOutput" style="display:none; margin-top:1rem;">
        <div class="label">Secret (send securely to receiver)</div>
        <textarea id="secretField" readonly rows="2"></textarea>
        <div class="highlight">Deposit Hash ready below</div>
        <button id="downloadBackup" class="btn-success" style="margin-top:1rem;">Download Backup (REQUIRED)</button>
        <div class="critical">Send the Secret to the receiver<br>They will withdraw 100% privately</div>
      </div>
    </div>
  </div>

  <!-- RECEIVER MODE -->
  <div id="receiverSection" style="display:none;">
    <div class="card">
      <div class="label">1. Secret from Depositor</div>
      <textarea id="receiverSecret" rows="2" placeholder="Paste 64-char secret here"></textarea>
      <button id="generateCommitBtn" class="btn" disabled>Generate Commit Hash</button>
      <div id="receiverOutput" style="display:none; margin-top:1rem;">
        <div class="highlight">Commit ready — go to Step 2</div>
        <div class="critical">After committing → wait ~13 min → withdraw</div>
      </div>
    </div>
  </div>

  <!-- WALLET -->
  <div class="card">
    <button id="connect" class="btn">Connect Wallet</button>
    <button id="disconnect" class="btn" style="display:none; margin-top:0.6rem;">Disconnect</button>
    <div id="status" style="margin-top:0.8rem; color:var(--muted);"></div>
  </div>

  <!-- LIVE STATS -->
  <div class="stat-grid">
    <div class="stat">
      <div class="stat-label">Total Burned</div>
      <div id="burnCounter" class="stat-value">—</div>
    </div>
    <div class="stat">
      <div class="stat-label">In Shield</div>
      <div id="shieldBalance" class="stat-value">—</div>
    </div>
  </div>

  <!-- DEPOSIT -->
  <div class="card">
    <div class="label">1. Deposit Amount (PRIVX)</div>
    <input id="depositAmount" placeholder="e.g. 5000" type="number" step="any" />
    <input id="depositHashField" readonly placeholder="Deposit Hash appears here" style="margin-top:0.8rem; background:#162d20; border-color:#22c55e;" />
    <button id="approveBtn" class="btn" disabled>Approve PRIVX</button>
    <button id="depositBtn" class="btn" style="margin-top:0.6rem;" disabled>Deposit + Mine Reward</button>
  </div>

  <!-- COMMIT -->
  <div class="card">
    <div class="label">2. Commit (Privacy Lock)</div>
    <div id="commitHashDisplay" class="highlight" style="display:none;">Commit Hash Ready</div>
    <button id="commitBtn" class="btn" disabled>Commit (~13 min lock)</button>
  </div>

  <!-- WITHDRAW -->
  <div class="card">
    <div class="label">3. Withdraw Privately</div>
    <input id="wallet1" placeholder="Fresh wallet 1" />
    <input id="wallet2" placeholder="Fresh wallet 2 (optional)" />
    <input id="wallet3" placeholder="Fresh wallet 3 (optional)" />
    <button id="withdrawBtn" class="btn" disabled>Withdraw (Random Split)</button>
    <small class="warning">Use brand-new wallets only</small>
  </div>

  <!-- CHECK DEPOSIT -->
  <div class="card">
    <div class="label">Check Any Deposit</div>
    <input id="checkHashInput" placeholder="0x..." />
    <button id="checkBtn" class="btn">Check Status</button>
    <div id="checkResult" class="check-result" style="display:none;"></div>
  </div>
</div>

<footer>
  PrivX Stealth Shield V13 • Sealed • Self-Funding • Immortal<br>
  Shield: 0x772Cc0a6AD3620447043b513717C4967b008D504<br>
  Vault: 0x5F92468586044b55e251D5e5E4dFF8376A146dF1<br>
  <a href="https://github.com/ELITEv5/PrivX" style="color:#a78bfa;">Elite Team6 © 2025</a>
</footer>

<script>
// === CONFIG ===
const SHIELD_CA = "0x772Cc0a6AD3620447043b513717C4967b008D504";
const VAULT_CA = "0x5F92468586044b55e251D5e5E4dFF8376A146dF1";
const TOKEN_CA = "0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986";
const RPCS = ["https://rpc.pulsechain.com","https://rpc-pulsechain.g4mm4.io","https://rpc.v4.testnet.pulsechain.com"];
let currentRpc = 0;
const getProvider = () => new ethers.providers.JsonRpcProvider(RPCS[currentRpc]);
let provider, signer, account;
let shield, token, pubShield;
let rawSecret = "", depositHash = "", commitHash = "";

// FULL ABI
const FULL_SHIELD_ABI = [{"type":"constructor","inputs":[{"name":"_privx","type":"address"}]},{"name":"SafeERC20FailedOperation","type":"error","inputs":[{"name":"token","type":"address"}]},{"name":"CommitMade","type":"event","inputs":[{"name":"user","type":"address","indexed":true},{"name":"commitHash","type":"bytes32","indexed":true}]},{"name":"Deposited","type":"event","inputs":[{"name":"hash","type":"bytes32","indexed":true},{"name":"amount","type":"uint256"},{"name":"depositor","type":"address","indexed":true}]},{"name":"Withdrawn","type":"event","inputs":[{"name":"hash","type":"bytes32","indexed":true},{"name":"amount","type":"uint256"},{"name":"outputs","type":"uint256"}]},{"name":"totalBurned","type":"function","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view"},{"name":"vaultBalance","type":"function","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view"},{"name":"deposits","type":"function","inputs":[{"name":"","type":"bytes32"}],"outputs":[{"name":"amount","type":"uint256"},{"name":"timestamp","type":"uint256"},{"name":"claimed","type":"bool"}],"stateMutability":"view"},{"name":"deposit","type":"function","inputs":[{"name":"amount","type":"uint256"},{"name":"secretHash","type":"bytes32"}],"outputs":[],"stateMutability":"nonpayable"},{"name":"commit","type":"function","inputs":[{"name":"commitHash","type":"bytes32"}],"outputs":[],"stateMutability":"nonpayable"},{"name":"withdraw","type":"function","inputs":[{"name":"secret","type":"string"},{"name":"recipients","type":"address[]"}],"outputs":[],"stateMutability":"nonpayable"}];
const TOKEN_ABI = ["function approve(address,uint256) returns(bool)","function allowance(address,address) view returns(uint256)"];

pubShield = new ethers.Contract(SHIELD_CA, FULL_SHIELD_ABI, getProvider());

// MODE
function setMode(m) {
  document.getElementById("depositorSection").style.display = m==="depositor"?"block":"none";
  document.getElementById("receiverSection").style.display = m==="receiver"?"block":"none";
  ["tabDepositor","tabReceiver"].forEach(id=>document.getElementById(id).classList.toggle("active",id==="tab"+(m==="depositor"?"Depositor":"Receiver")));
}

// CONNECT WALLET
async function connectWallet() {
  if (!window.ethereum) return alert("Install MetaMask");
  try {
    await window.ethereum.request({method:"eth_requestAccounts"});
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner(); account = await signer.getAddress();
    const net = await provider.getNetwork();
    if (net.chainId !== 369) await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x171"}]});
    document.getElementById("status").textContent = `Connected: ${account.slice(0,8)}…${account.slice(-6)}`;
    document.getElementById("connect").style.display="none"; document.getElementById("disconnect").style.display="block";
    shield = new ethers.Contract(SHIELD_CA, FULL_SHIELD_ABI, signer);
    token = new ethers.Contract(TOKEN_CA, TOKEN_ABI, signer);
    document.getElementById("generateDepositBtn").disabled = false;
    updateStats(); setInterval(updateStats,15000);
  } catch(e) { alert("Failed: "+e.message); }
}
document.getElementById("connect").onclick = connectWallet;
document.getElementById("disconnect").onclick = ()=>location.reload();

// STATS
async function updateStats() {
  try {
    const [burned, bal] = await Promise.all([pubShield.totalBurned(), pubShield.vaultBalance()]);
    document.getElementById("burnCounter").textContent = Number(ethers.utils.formatUnits(burned,18)).toLocaleString();
    document.getElementById("shieldBalance").textContent = Number(ethers.utils.formatUnits(bal,18)).toLocaleString();
  } catch(e) {
    currentRpc = (currentRpc+1)%RPCS.length;
    pubShield = new ethers.Contract(SHIELD_CA, FULL_SHIELD_ABI, getProvider());
    setTimeout(updateStats,3000);
  }
}
updateStats();

// DEPOSITOR
document.getElementById("generateDepositBtn").onclick = () => {
  const bytes = crypto.getRandomValues(new Uint8Array(32));
  rawSecret = Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
  depositHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(rawSecret));
  document.getElementById("secretField").value = rawSecret;
  document.getElementById("depositHashField").value = depositHash;
  document.getElementById("depositorOutput").style.display = "block";
  document.getElementById("downloadBackup").onclick = () => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([`Secret: ${rawSecret}\nHash: ${depositHash}`],{type:"text/plain"}));
    a.download = "privx-backup.txt"; a.click();
  };
  ["approveBtn","depositBtn"].forEach(id=>document.getElementById(id).disabled=false);
};

// RECEIVER — FINAL WORKING V13 COMMIT (ADDRESS FIRST)
document.getElementById("receiverSecret").oninput = () => {
  const s = document.getElementById("receiverSecret").value.trim();
  document.getElementById("generateCommitBtn").disabled = s.length !== 64;
};

document.getElementById("generateCommitBtn").onclick = () => {
  rawSecret = document.getElementById("receiverSecret").value.trim().toLowerCase();
  
  // THIS IS THE REAL V13 LOGIC — ADDRESS FIRST
  commitHash = ethers.utils.keccak256(
    ethers.utils.solidityPack(["address","string"], [account.toLowerCase(), rawSecret])
  );
  
  console.log("V13 COMMIT HASH →", commitHash); // ← you’ll see 0x442638a89...
  
  document.getElementById("commitHashDisplay").innerHTML = `Commit Hash Ready<br><small>${commitHash}</small>`;
  document.getElementById("commitHashDisplay").style.display = "block";
  document.getElementById("receiverOutput").style.display = "block";
  document.getElementById("commitBtn").disabled = false;
  document.getElementById("withdrawBtn").disabled = false;
};

// ACTIONS
document.getElementById("approveBtn").onclick = async () => {
  try { await (await token.approve(SHIELD_CA, ethers.constants.MaxUint256)).wait(); alert("Approved!"); }
  catch(e) { alert("Approve failed: "+e.message); }
};

document.getElementById("depositBtn").onclick = async () => {
  const amt = document.getElementById("depositAmount").value;
  if (!amt || !depositHash) return alert("Missing amount or hash");
  try { const tx = await shield.deposit(ethers.utils.parseUnits(amt,18), depositHash); alert(`Deposited!\nTx: ${tx.hash}`); }
  catch(e) { alert(e.message.includes("Hash used")?"Hash already used":"Deposit failed"); }
};

document.getElementById("commitBtn").onclick = async () => {
  try { const tx = await shield.commit(commitHash); alert(`Committed!\nTx: ${tx.hash}`); }
  catch(e) { alert("Commit failed: "+e.message); }
};

document.getElementById("withdrawBtn").onclick = async () => {
  const wallets = ["wallet1","wallet2","wallet3"].map(id=>document.getElementById(id).value.trim()).filter(a=>ethers.utils.isAddress(a));
  if (!wallets.length) return alert("Add at least one fresh wallet");
  try { const tx = await shield.withdraw(rawSecret, wallets); alert(`GHOSTED!\nTx: ${tx.hash}`); }
  catch(e) { alert("Withdraw failed — did you wait after commit?"); }
};

document.getElementById("checkBtn").onclick = async () => {
  const h = document.getElementById("checkHashInput").value.trim();
  if (!h.startsWith("0x") || h.length!==66) return document.getElementById("checkResult").innerHTML = "Invalid hash", void(document.getElementById("checkResult").style.display="block");
  try {
    const d = await pubShield.deposits(h);
    if (d.amount.isZero()) return document.getElementById("checkResult").innerHTML = "No deposit", void(document.getElementById("checkResult").style.display="block");
    const amt = Number(ethers.utils.formatUnits(d.amount,18)).toFixed(2);
    const claimed = d.claimed;
    const expires = Number(d.timestamp)+7*86400;
    const daysLeft = Math.max(0,(expires-Date.now()/1000)/86400).toFixed(1);
    const status = claimed ? `<span class="check-claimed">Withdrawn</span>` :
                   daysLeft==0 ? `<span class="check-expired">Reclaimable (5% bounty)</span>` :
                   `<span class="check-active">Active — ${daysLeft} days left</span>`;
    document.getElementById("checkResult").innerHTML = `<strong>${amt} PRIVX</strong><br>Status: ${status}`;
    document.getElementById("checkResult").style.display = "block";
  } catch { document.getElementById("checkResult").innerHTML = "Error"; document.getElementById("checkResult").style.display="block"; }
};
</script>
</body>
</html>
