<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>PrivX Stealth Shield</title>

<!-- PWA META -->
<meta name="theme-color" content="#0f1117" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="PrivX Shield" />

<!-- ICONS -->
<link rel="icon" href="icon-512.png" sizes="512x512" />
<link rel="apple-touch-icon" href="icon-512.png" />
<link rel="manifest" href="manifest.json" />

<script src="ethers.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0f1117;
    --card:#171a21;
    --text:#e2e8f0;
    --muted:#94a3b8;
    --primary:#a78bfa;
    --success:#22c55e;
    --border:#2d3748;
    --critical-bg:#7f1d1d;
    --critical-text:#fca5a5;
  }

  body {
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:'Inter',sans-serif;
    line-height:1.6;
  }

  .container {
    max-width:460px;
    margin:2rem auto;
    padding:0 1rem;
  }

  header {
    text-align:center;
    padding:2.5rem 0 1.5rem;
  }

  header img {
    height:96px;
    border-radius:20px;
    box-shadow:0 10px 40px rgba(167,139,250,0.5);
  }

  header h1 {
    font-size:2rem;
    margin:1rem 0 0.4rem;
    color:white;
    font-weight:700;
    background:linear-gradient(90deg,#a78bfa,#ec4899);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  header p {
    color:var(--muted);
    font-size:1.05rem;
  }

  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:1.6rem;
    margin:1.6rem 0;
  }

  /* === BUTTONS === */
  .btn {
    background:var(--primary);
    color:white;
    border:none;
    border-radius:12px;
    padding:1rem;
    width:100%;
    font-weight:600;
    cursor:pointer;
    transition:0.2s;
    font-size:1.1rem;
  }

  .btn:hover { background:#8b5cf6; }
  .btn:disabled { background:#334155; cursor:not-allowed; opacity:0.7; }
  .btn-success { background:var(--success); }
  .btn-accent { background:var(--primary); color:white; }
  .btn-accent:hover { background:#8b5cf6; }

  input, textarea {
    width:100%;
    padding:1rem;
    border-radius:12px;
    border:1px solid var(--border);
    background:#1e2533;
    color:white;
    font-size:1rem;
    margin:0.6rem 0;
    box-sizing:border-box;
    font-family:monospace;
  }

  .label {
    display:block;
    margin:1.4rem 0 0.5rem;
    font-size:1rem;
    color:var(--muted);
    font-weight:500;
  }

  .critical {
    background:var(--critical-bg);
    color:var(--critical-text);
    padding:1.2rem;
    border-radius:12px;
    margin:1.4rem 0;
    font-weight:600;
    text-align:center;
  }

  .warning {
    color:#ec4899;
    font-size:0.95rem;
    margin-top:0.6rem;
    display:block;
  }

  /* === TABS === */
  .tab {
    padding:1rem;
    background:#1e2533;
    border-radius:12px;
    cursor:pointer;
    text-align:center;
    margin:0.5rem 0;
    font-size:0.9rem;
    transition:0.2s;
  }

  .tab.active {
    background:var(--primary);
    color:white;
    font-weight:600;
  }

  /* === HIGHLIGHTS & STATUS === */
  .highlight {
    background:#1e4d3d;
    color:#22c55e;
    padding:0.8rem;
    border-radius:8px;
    margin:1rem 0;
    font-family:monospace;
    font-weight:bold;
    text-align:center;
  }

  .check-result {
    background:#1e2533;
    border-radius:12px;
    padding:1.2rem;
    margin-top:1rem;
    font-size:1rem;
    line-height:1.8;
  }

  .check-active { color:#22c55e; font-weight:600; }
  .check-claimed { color:#ef4444; font-weight:600; }
  .check-expired { color:#a78bfa; font-weight:600; }

  /* === STATS === */
  .stat-grid {
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:1rem;
    margin:1.5rem 0;
  }

  .stat {
    background:#1e2533;
    border-radius:12px;
    padding:1.2rem;
    text-align:center;
  }

  .stat-label { font-size:0.9rem; color:var(--muted); }
  .stat-value { font-size:1.5rem; font-weight:700; color:white; margin-top:0.4rem; }

  /* === FOOTER === */
  footer {
    text-align:center;
    padding:2.5rem;
    color:#475569;
    font-size:0.9rem;
  }

  /* === FLASH WARNING (for unsaved secrets) === */
  #flashWarning {
    display:none;
    text-align:center;
    background:#7f1d1d;
    color:#fca5a5;
    font-weight:700;
    padding:0.8rem;
    border-radius:10px;
    margin-top:1rem;
    transition:opacity 0.5s;
  }

  /* === COPY NOTICE === */
  #copyNotice {
    display:none;
    text-align:center;
    color:var(--success);
    margin-top:0.5rem;
    font-size:0.9rem;
  }
  /* === UNIFIED ACTION BUTTONS (Buy + Reclaim) === */
.btn-action {
  background:linear-gradient(90deg,#a78bfa,#8b5cf6);
  color:white;
  border:none;
  border-radius:14px;
  padding:1rem;
  width:100%;
  font-weight:700;
  cursor:pointer;
  font-size:1.1rem;
  transition:all 0.25s ease;
  box-shadow:0 0 20px rgba(167,139,250,0.25);
}

.btn-action:hover {
  background:linear-gradient(90deg,#b794f4,#c084fc);
  box-shadow:0 0 30px rgba(167,139,250,0.45);
  transform:translateY(-1px);
}

.btn-action:disabled {
  background:#334155;
  cursor:not-allowed;
  opacity:0.7;
}

/* Reclaim section labels and headers */
#reclaimTab h2 {
  color:#a78bfa !important; /* replaces gold headers */
}

#reclaimTab .btn-action {
  margin-top:0.5rem;
}

#reclaimTab .reclaim-item strong {
  color:#e2e8f0; /* neutral text */
}

#reclaimTab .reclaim-item {
  background:#1e2533;
  border:1px solid #2d3748;
  border-radius:16px;
  padding:1rem;
  margin:0.8rem 0;
}
  /* === PREMIUM GLOW EFFECT FOR ALL PRIMARY ACTIONS === */
.btn, .btn-success, .btn-accent, .btn-action {
  position:relative;
  transition:all 0.25s ease;
  box-shadow:0 0 15px rgba(167,139,250,0.15);
}

.btn:hover,
.btn-success:hover,
.btn-accent:hover,
.btn-action:hover {
  transform:translateY(-1px);
  box-shadow:0 0 25px rgba(167,139,250,0.35);
}

/* Special success hover (green) */
.btn-success:hover {
  box-shadow:0 0 25px rgba(34,197,94,0.35);
}

/* Smooth pulse for Connect Wallet when disconnected */
#connect:not([disabled]) {
  animation:pulseGlow 2s infinite ease-in-out;
}

@keyframes pulseGlow {
  0%   { box-shadow:0 0 0 rgba(167,139,250,0.0); }
  50%  { box-shadow:0 0 20px rgba(167,139,250,0.4); }
  100% { box-shadow:0 0 0 rgba(167,139,250,0.0); }
}
  /* === MOBILE OPTIMIZATION (PrivX V13) === */
@media (max-width: 480px) {
  .container {
    max-width: 100%;
    padding: 0.5rem;
  }

  header img {
    height: 72px;
  }

  header h1 {
    font-size: 1.5rem;
  }

  .card {
    padding: 1.2rem;
    margin: 1rem 0;
  }

  .btn, .btn-action {
    font-size: 1rem;
    padding: 0.9rem;
  }

  textarea, input {
    font-size: 0.9rem;
  }

  .stat-grid {
    grid-template-columns: 1fr;
  }

  .tab {
    padding: 0.8rem;
    font-size: 0.8rem;
  }

  footer {
    font-size: 0.8rem;
    padding: 1.5rem;
  }

  body {
    padding-bottom: env(safe-area-inset-bottom);
  }
}
</style>
</head>

<body>
<div class="container">
  <header>
    <img src="PRIVX.png" alt="PrivX Shield">
    <h1>PrivX Stealth Shield</h1>
    <p>Proof Of Privacy</p>
  </header>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MAIN NAVIGATION TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="card">
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.5rem;">
      <div class="tab active" id="tabShield" onclick="setMainTab('shield')">SHIELD</div>
      <div class="tab" id="tabVault" onclick="setMainTab('vault')">MINING VAULT</div>
      <div class="tab" id="tabReclaim" onclick="setMainTab('reclaim')">RECLAIM</div>
      <div class="tab" id="tabAbout" onclick="setMainTab('about')">HOW TO</div>
    </div>
  </div>

  <!-- Shared Stats Panel -->
  <div class="stat-grid">
    <div class="stat"><div class="stat-label">Total Burned</div><div id="burnCounter" class="stat-value">‚Äî</div></div>
    <div class="stat"><div class="stat-label">In Shield</div><div id="shieldBalance" class="stat-value">‚Äî</div></div>
    <div class="stat"><div class="stat-label">Vault Balance</div><div id="vaultBalance" class="stat-value">‚Äî</div></div>
  </div>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SHIELD TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="shieldTab">

    <!-- üîå CONNECT WALLET CARD -->
    <div class="card">
      <button id="connect" class="btn">Connect Wallet</button>
      <button id="disconnect" class="btn" style="display:none; margin-top:0.6rem;">Disconnect</button>
      <div id="status" style="margin-top:0.8rem; color:var(--muted); text-align:center;"></div>
    </div>

   <!-- üí∞ BUY PRIVX + COPY CA -->
<div class="card" style="text-align:center;">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
    <!-- Buy PRIVX -->
    <button class="btn-action"
      onclick="window.open('https://app.pulsex.com/swap?outputCurrency=0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986','_blank')">
      Buy PRIVX
    </button>

    <!-- Copy Contract Address -->
    <button class="btn-action" onclick="copyPrivxCA()">
      Copy CA
    </button>
  </div>

  <div id="copyNotice" style="display:none; color:#22c55e; margin-top:0.6rem;">
    ‚úÖ Copied!
  </div>
</div>

    <!-- ‚ö† FLASH WARNING FOR UNSAVED SECRETS -->
    <div id="flashWarning"
         style="display:none; position:fixed; top:1rem; left:50%; transform:translateX(-50%);
                background:#7f1d1d; color:#fca5a5; padding:1rem 1.5rem; border-radius:10px;
                font-weight:600; z-index:9999; opacity:0; transition:opacity 0.4s ease;">
      ‚ö†Ô∏è Save your backup before generating a new secret!
    </div>

    <!-- MODE SELECTOR -->
    <div class="card">
      <div class="label">Mode</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
        <div class="tab active" id="tabDepositor" onclick="setMode('depositor')">Depositor</div>
        <div class="tab" id="tabReceiver" onclick="setMode('receiver')">Receiver</div>
      </div>
    </div>

    <!-- üü£ DEPOSITOR SECTION -->
    <div id="depositorSection">
      <div class="card">
        <div class="label">1. Generate Secret + Hash</div>
        <button id="generateDepositBtn" class="btn">Generate New Secret</button>

        <div id="depositorOutput" style="display:none; margin-top:1.5rem;">
          <div class="label">Your Secret (64 chars)</div>
          <textarea id="secretField" readonly rows="2"></textarea>

          <div class="label" style="margin-top:1rem;">Deposit Hash</div>
          <input id="depositHashField" readonly
                 style="background:#162d20; border-color:#22c55e;" />

          <div class="critical" style="margin:1.2rem 0;">
            You MUST download backup before depositing!<br>
            Without it you will lose your funds forever.
          </div>

          <button id="downloadBackup" class="btn-success">
            Download Backup .txt (REQUIRED)
          </button>
          <div style="margin-top:1.5rem; text-align:center;">
  <button id="generateQrBtn" class="btn-success" style="width:100%;">
    Generate QR Code (for Receiver)
  </button>
  <div id="qrContainer" style="margin-top:1rem; display:none;">
    <canvas id="qrCanvas"></canvas>
    <div style="margin-top:0.8rem;">
      <button id="downloadQrBtn" class="btn" style="background:#8b5cf6;">
        Download QR Code (.png)
      </button>
    </div>
    <small style="color:#94a3b8; display:block; margin-top:0.6rem;">
      Show this QR to receiver ‚Äî they scan ‚Üí auto-fill secret
    </small>
        </div>
      </div>

      <div class="card">
        <div class="label">Amount to Deposit (PRIVX)</div>
        <input id="depositAmount" type="number" step="any" placeholder="e.g. 5000" />
        <button id="approveBtn" class="btn" disabled style="margin-top:1rem;">
          Approve PRIVX
        </button>
        <button id="depositBtn" class="btn" disabled style="margin-top:0.8rem;">
          Deposit + Mine Reward
        </button>
      </div>
    </div>

    <!-- üü¢ RECEIVER SECTION -->
    <div id="receiverSection" style="display:none;">
      <div class="card">
        <div class="label">1. Secret from Depositor</div>
        <textarea id="receiverSecret" rows="2"
                  placeholder="Paste 64-char secret here"></textarea>
        <button id="generateCommitBtn" class="btn" disabled>
          Generate Commit Hash
        </button>
      </div>

      <div class="card">
        <div class="label">2. Commit (Privacy Lock)</div>
        <div id="commitHashDisplay" class="highlight" style="display:none;">
          Commit Hash Ready
        </div>
        <button id="commitBtn" class="btn" disabled>
          Commit (~13 min lock)
        </button>
      </div>

      <div class="card">
        <div class="label">3. Withdraw Privately</div>
        <input id="wallet1" placeholder="Fresh wallet 1" />
        <input id="wallet2" placeholder="Fresh wallet 2 (optional)" />
        <input id="wallet3" placeholder="Fresh wallet 3 (optional)" />
        <button id="withdrawBtn" class="btn" disabled>
          Withdraw (Random Split)
        </button>
        <small class="warning">Use brand-new wallets only</small>
      </div>
    </div>

    <!-- üîç CHECK DEPOSIT -->
    <div class="card">
      <div class="label">Check Any Deposit</div>
      <input id="checkHashInput" placeholder="0x..." />
      <button id="checkBtn" class="btn">Check Status</button>
      <div id="checkResult" class="check-result" style="display:none;"></div>
    </div>

  </div> <!-- end shieldTab -->
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MINING VAULT TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="vaultTab" style="display:none;">
    <div class="card">
      <h2 style="text-align:center; color:#a78bfa; margin:0;">Mining Vault Live Stats</h2>
      <p style="text-align:center; color:var(--muted); font-size:0.9rem;">
        Dynamic rewards = Proof of Privacy
      </p>
      <div id="vaultData" style="margin-top:1.5rem; text-align:center; line-height:1.8;"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ôª RECLAIM TAB (Updated Style) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="reclaimTab" style="display:none;">
  <div class="card">
    <h2 style="text-align:center; color:#a78bfa; margin:0;">‚ôª Reclaim Expired Deposits</h2>
    <p style="text-align:center; color:var(--muted); font-size:0.9rem;">
      5% bounty ‚Ä¢ 0.3% fee ‚Ä¢ Automatic burn
    </p>

    <div class="label">Deposit Hash (0x...)</div>
    <input id="reclaimInput" placeholder="Paste or auto-detected hash" />
    
    <button id="claimBtn" class="btn-action" style="margin-top:1rem;">
      Claim Deposit
    </button>

    <div id="reclaimStatus" style="text-align:center; color:var(--muted); margin-top:1rem;"></div>
  </div>
</div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HOW TO TAB (Replaces About) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="aboutTab" style="display:none;">
  <div class="card">
    <h2 style="text-align:center; color:#a78bfa;">How to Use PrivX Stealth Shield</h2>

    <p style="line-height:1.8; font-size:0.95rem;">
      <strong>Every blockchain transaction is public.</strong>  
      Every balance, every address, every connection ‚Äî all visible, forever.  
      Transparency was meant for systems, not for people.
    </p>

    <p>
      <strong>PrivX Stealth Shield</strong> restores the human right to transact privately.
      It‚Äôs not about hiding ‚Äî it‚Äôs about <strong>freedom</strong>:  
      the ability to act without being profiled, tracked, or targeted.
    </p>

    <p>
      When hundreds of users shield funds together, something powerful happens:
      <strong>statistical invisibility</strong>.  
      Each deposit adds noise, each withdrawal blends deeper into the crowd.
      There‚Äôs no centralized mixer ‚Äî only math and participation.
    </p>

    <blockquote style="border-left:3px solid #8b5cf6;padding-left:1rem;margin:1rem 0;color:#ccc;">
      ‚ÄúCash doesn‚Äôt make you a criminal. It makes you free.  
      Privacy on-chain should be no different.‚Äù
    </blockquote>

    <h3 style="margin-top:2rem;color:#a78bfa;">üß≠ Step-by-Step Guide</h3>
    <ol style="margin-left:1.2rem; line-height:1.8;">
      <li><strong>Generate a Secret:</strong>  
          Press <em>‚ÄúGenerate New Secret‚Äù</em>. This creates a random 64-character key and its hash.</li>
      <li><strong>Backup Immediately:</strong>  
          Download the backup .txt file before doing anything else.  
          Losing your secret means losing your deposit forever ‚Äî there is no recovery.</li>
      <li><strong>Deposit PRIVX:</strong>  
          Approve and deposit your chosen amount.  
          The Shield takes a small <strong>0.3 % fee</strong> which is automatically burned and partially sent to the Mining Vault.</li>
      <li><strong>Share the Secret:</strong>  
          Send your secret string privately (never the hash) to your intended receiver.</li>
      <li><strong>Receiver Commits:</strong>  
          The receiver pastes the secret, generates a commit hash, and submits it on-chain.  
          This locks the withdrawal window for ~13 minutes (‚âà 100 blocks).</li>
      <li><strong>Withdraw Privately:</strong>  
          After the commit window, the receiver can withdraw to 1‚Äì3 new wallets.  
          The Shield splits the amount randomly ‚Äî unlinkable on-chain.</li>
      <li><strong>Reclaim (optional):</strong>  
          If a deposit is never withdrawn after 7 days, anyone can reclaim it.  
          The original amount is burned minus a small <strong>5 % bounty</strong> to the reclaimer.</li>
    </ol>

    <h3 style="margin-top:2rem;color:#a78bfa;">üîê Safety & Privacy Best Practices</h3>
    <ul style="margin-left:1.2rem; line-height:1.8;">
      <li>Always <strong>download your backup</strong> and store it offline.</li>
      <li>Do <strong>not reuse wallets</strong> for withdrawals ‚Äî use fresh addresses every time.</li>
      <li>Never reveal your secret on-chain, in DMs, or screenshots.</li>
      <li>Perform commits and withdrawals using different devices or IPs if possible.</li>
      <li>Wait several minutes between transactions for maximum anonymity.</li>
      <li>The Shield contract is <strong>immutable and non-custodial</strong>; no admin can help recover lost secrets.</li>
    </ul>

    <h3 style="margin-top:2rem;color:#a78bfa;">‚öôÔ∏è How the Mining Vault Works</h3>
    <p style="line-height:1.8;">
      Every deposit and reclaim contributes a small <strong>0.3 % fee</strong>.  
      80 % of this fee is permanently burned, and 20 % flows into the <strong>Mining Vault V13</strong>.  
      The Vault continuously distributes <em>PRIVX mining rewards</em> to users who deposit or reclaim ‚Äî  
      rewarding participation in the Shield ecosystem.
    </p>

    <p>
      The Vault‚Äôs reward rate adjusts automatically based on its balance and the total network activity.
      Depositing when the Vault is full yields higher rewards; as it empties, rates normalize.
      This creates a <strong>self-balancing, deflationary economy</strong> that rewards early privacy adopters.
    </p>

    <p style="margin-top:2rem; color:#94a3b8; text-align:center;">
      <em>Mathematical privacy, automated rewards, and zero custodial risk ‚Äî  
      this is the PrivX Stealth Shield V13.</em>
    </p>
  </div>
</div>

<footer>SHIELD_CA = 0x772Cc0a6AD3620447043b513717C4967b008D504
PrivX_CA  = 0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986
Mining VAULT_CA  = 0x5F92468586044b55e251D5e5E4dFF8376A146dF1 
  PrivX Stealth Shield V13 ‚Ä¢ Elite Team6 ¬© 2025</footer>

<script>
// ==========================================================
//  PRIVX STEALTH SHIELD V13 ‚Äî IMMORTAL BUILD FINAL (fixed)
// ==========================================================
const SHIELD_CA = "0x772Cc0a6AD3620447043b513717C4967b008D504";
const TOKEN_CA  = "0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986";
const VAULT_CA  = "0x5F92468586044b55e251D5e5E4dFF8376A146dF1";

const RPCS = [
  "https://rpc.pulsechain.com",
  "https://rpc-pulsechain.g4mm4.io",
];
let currentRpc = 0;
const getProvider = ()=>new ethers.providers.JsonRpcProvider(RPCS[currentRpc]);

// ‚úÖ Core state variables
let provider, signer, account, shield, token, vault, pubShield, pubVault;
let rawSecret="", depositHash="", commitHash="";
let backupDownloaded=false; // <-- keep only this line, NOT lastReclaimableHash here

console.log("‚úÖ PrivX Stealth Shield init success (top section loaded)");

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ABIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FULL_SHIELD_ABI=[
 {"name":"totalBurned","type":"function","outputs":[{"type":"uint256"}],"stateMutability":"view"},
 {"name":"vaultBalance","type":"function","outputs":[{"type":"uint256"}],"stateMutability":"view"},
 {"name":"deposits","type":"function","inputs":[{"type":"bytes32"}],"outputs":[{"type":"uint256"},{"type":"uint256"},{"type":"bool"}],"stateMutability":"view"},
 {"name":"deposit","type":"function","inputs":[{"type":"uint256"},{"type":"bytes32"}],"stateMutability":"nonpayable"},
 {"name":"commit","type":"function","inputs":[{"type":"bytes32"}],"stateMutability":"nonpayable"},
 {"name":"withdraw","type":"function","inputs":[{"type":"string"},{"type":"address[]"}],"stateMutability":"nonpayable"},
 {"name":"reclaim","type":"function","inputs":[{"type":"bytes32"}],"stateMutability":"nonpayable"}
];

const TOKEN_ABI=[
 "function approve(address,uint256) returns(bool)",
 "function allowance(address,address) view returns(uint256)"
];
const VAULT_ABI=[
 "function vaultBalance() view returns(uint256)",
 "function totalMined() view returns(uint256)",
 "function currentRateBp() view returns(uint256)"
];

pubShield=new ethers.Contract(SHIELD_CA,FULL_SHIELD_ABI,getProvider());
pubVault=new ethers.Contract(VAULT_CA,VAULT_ABI,getProvider());
const TOKEN_ABI_SIMPLE = ["function balanceOf(address) view returns (uint256)"];
const pubToken = new ethers.Contract(TOKEN_CA, TOKEN_ABI_SIMPLE, getProvider());
const BURN_ADDRESS = "0x000000000000000000000000000000000000dEaD";
const PULSECHAIN_BURN = "0x0000000000000000000000000000000000000369";



// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB CONTROL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMainTab(tab){
  const tabs={shield:"shieldTab",vault:"vaultTab",reclaim:"reclaimTab",about:"aboutTab"};
  for(const t in tabs)
    document.getElementById(tabs[t]).style.display=t===tab?"block":"none";
  ["tabShield","tabVault","tabReclaim","tabAbout"].forEach(id=>
    document.getElementById(id).classList.toggle("active",id==="tab"+tab.charAt(0).toUpperCase()+tab.slice(1))
  );
  if(tab==="vault") loadVaultStats();
  if(tab==="reclaim") loadReclaimTab();
}
function setMode(m){
 document.getElementById("depositorSection").style.display=m==="depositor"?"block":"none";
 document.getElementById("receiverSection").style.display=m==="receiver"?"block":"none";
 ["tabDepositor","tabReceiver"].forEach(id=>
  document.getElementById(id).classList.toggle("active",id==="tab"+(m==="depositor"?"Depositor":"Receiver")));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WALLET CONNECT (Smart Mobile/Desktop Logic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function connectWallet() {
  try {
    const isMobile = /android|iphone|ipad|ipod/i.test(navigator.userAgent);

    if (window.ethereum && (!isMobile || window.ethereum.isMetaMask || window.ethereum.isTrust)) {
      // ‚úÖ Use injected provider (MetaMask, Brave, Trust, etc.)
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum);
    } else if (!isMobile) {
      // ‚úÖ Desktop fallback (WalletConnect QR)
      const wc = new WalletConnectProvider.default({
        rpc: { 369: "https://rpc.pulsechain.com" },
        chainId: 369,
        qrcode: true
      });
      await wc.enable();
      provider = new ethers.providers.Web3Provider(wc);
    } else {
      // ‚ùå Mobile browser without injected wallet
      alert("Please open this site inside your wallet browser (e.g. MetaMask or Trust Wallet).");
      return;
    }

    signer = provider.getSigner();
    account = await signer.getAddress();
    const net = await provider.getNetwork();

    if (net.chainId !== 369) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: "0x171" }]);
      } catch (err) {
        console.warn("‚ö†Ô∏è Chain switch failed", err);
      }
    }

    shield = new ethers.Contract(SHIELD_CA, FULL_SHIELD_ABI, signer);
    token  = new ethers.Contract(TOKEN_CA, TOKEN_ABI, signer);
    vault  = new ethers.Contract(VAULT_CA, VAULT_ABI, signer);

    document.getElementById("status").textContent =
      `Connected: ${account.slice(0,8)}‚Ä¶${account.slice(-6)}`;
    document.getElementById("connect").style.display = "none";
    document.getElementById("disconnect").style.display = "block";
    document.getElementById("generateDepositBtn").disabled = false;

    updateStats();
    setInterval(updateStats, 15000);
  } catch (e) {
    alert("Wallet connection failed: " + e.message);
  }
}
document.getElementById("connect").onclick=connectWallet;
document.getElementById("disconnect").onclick=()=>location.reload();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATS (True Burn ‚Äî All Known Burn Addresses) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function updateStats() {
  try {
    const [
      burnedFromContract,
      burnedFromDead,
      burnedFromPulseBurn,
      shieldBal,
      vaultBal
    ] = await Promise.all([
      pubShield.totalBurned(),                         // internal contract burns
      pubToken.balanceOf(BURN_ADDRESS),                // main burn sink (0x...dEaD)
      pubToken.balanceOf(PULSECHAIN_BURN),             // secondary Pulse burn sink (0x...0369)
      pubShield.vaultBalance(),
      pubVault.vaultBalance()
    ]);

    // True burn = all sinks + contract burns
    const totalBurned = burnedFromContract
      .add(burnedFromDead)
      .add(burnedFromPulseBurn);

    document.getElementById("burnCounter").textContent =
      Number(ethers.utils.formatUnits(totalBurned, 18)).toLocaleString();

    document.getElementById("shieldBalance").textContent =
      Number(ethers.utils.formatUnits(shieldBal, 18)).toLocaleString();

    document.getElementById("vaultBalance").textContent =
      Number(ethers.utils.formatUnits(vaultBal, 18)).toLocaleString();

  } catch (e) {
    console.warn("‚ö†Ô∏è updateStats RPC issue", e.message);
    currentRpc = (currentRpc + 1) % RPCS.length;
    pubShield = new ethers.Contract(SHIELD_CA, FULL_SHIELD_ABI, getProvider());
    pubVault  = new ethers.Contract(VAULT_CA, VAULT_ABI, getProvider());
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VAULT STATS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadVaultStats(){
 const div=document.getElementById("vaultData"); div.innerHTML="Loading live data...";
 try{
   const [bal,mined,rate]=await Promise.all([
     pubVault.vaultBalance(),pubVault.totalMined(),pubVault.currentRateBp()]);
   div.innerHTML=`<div><strong>Vault Balance:</strong><br>${Number(ethers.utils.formatUnits(bal,18)).toLocaleString()} PRIVX</div>
   <div style='margin-top:0.8rem;'><strong>Total Mined:</strong><br>${Number(ethers.utils.formatUnits(mined,18)).toLocaleString()} PRIVX</div>
   <div style='margin-top:0.8rem;'><strong>Current Rate:</strong><br>${(Number(rate)/100).toFixed(2)} % per deposit</div>`;
 }catch(e){div.innerHTML="‚ö†Ô∏è Vault data unavailable (RPC issue)";}
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SHIELD CORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flashWarning(msg="‚ö†Ô∏è Save backup before generating new secret!"){
 const w=document.getElementById("flashWarning");w.textContent=msg;
 w.style.display="block";w.style.opacity=1;setTimeout(()=>w.style.opacity=0,1800);
 setTimeout(()=>w.style.display="none",2000);
}
function copyPrivxCA(){
 navigator.clipboard.writeText(TOKEN_CA);
 const n=document.getElementById("copyNotice");n.style.display="block";
 setTimeout(()=>n.style.display="none",2000);
}

document.getElementById("generateDepositBtn").onclick=()=>{
 if(rawSecret&&!backupDownloaded)return flashWarning();
 const bytes=crypto.getRandomValues(new Uint8Array(32));
 rawSecret=Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
 depositHash=ethers.utils.keccak256(ethers.utils.defaultAbiCoder.encode(["string"],[rawSecret]));
 document.getElementById("secretField").value=rawSecret;
 document.getElementById("depositHashField").value=depositHash;
 document.getElementById("depositorOutput").style.display="block";
 backupDownloaded=false;
 document.getElementById("approveBtn").disabled=true;
 document.getElementById("depositBtn").disabled=true;
};

document.getElementById("downloadBackup").onclick=()=>{
 const blob=new Blob([`PRIVX V13 BACKUP\nSecret: ${rawSecret}\nHash: ${depositHash}\nDate: ${new Date().toLocaleString()}`],
 {type:"text/plain"});
 const a=document.createElement("a");a.href=URL.createObjectURL(blob);
 a.download="privx-v13-backup.txt";a.click();
 backupDownloaded=true;
 document.getElementById("approveBtn").disabled=false;
 document.getElementById("depositBtn").disabled=false;
 alert("Backup saved! You can now deposit.");
};

document.getElementById("receiverSecret").oninput=()=>{
 const s=document.getElementById("receiverSecret").value.trim();
 document.getElementById("generateCommitBtn").disabled=s.length!==64;
};
document.getElementById("generateCommitBtn").onclick=()=>{
 rawSecret=document.getElementById("receiverSecret").value.trim();
 commitHash=ethers.utils.keccak256(ethers.utils.solidityPack(["string","address"],[rawSecret,account]));
 document.getElementById("commitHashDisplay").innerHTML=`Commit Hash Ready<br><small>${commitHash}</small>`;
 document.getElementById("commitHashDisplay").style.display="block";
 document.getElementById("commitBtn").disabled=false;
 document.getElementById("withdrawBtn").disabled=false;
};

document.getElementById("approveBtn").onclick=async()=>{
 try{await(await token.approve(SHIELD_CA,ethers.constants.MaxUint256)).wait();alert("Approved successfully!");}
 catch(e){alert("Approve failed: "+e.message);}
};
document.getElementById("depositBtn").onclick=async()=>{
 if(!backupDownloaded)return alert("Download backup first!");
 const amt=document.getElementById("depositAmount").value;
 if(!amt||!depositHash)return alert("Missing amount or hash");
 try{const tx=await shield.deposit(ethers.utils.parseUnits(amt,18),depositHash);
 alert(`Deposited!\nTx: ${tx.hash}`);}catch(e){alert("Deposit failed: "+e.message);}
};
document.getElementById("commitBtn").onclick=async()=>{
 try{const tx=await shield.commit(commitHash);alert(`Committed!\nTx: ${tx.hash}`);}
 catch(e){alert("Commit failed: "+e.message);}
};
document.getElementById("withdrawBtn").onclick=async()=>{
 const wallets=["wallet1","wallet2","wallet3"].map(id=>document.getElementById(id).value.trim())
   .filter(a=>ethers.utils.isAddress(a));
 if(!wallets.length)return alert("Add at least one fresh wallet.");
 try{const tx=await shield.withdraw(rawSecret,wallets);
 alert(`‚úÖ Withdraw Complete!\nTx: ${tx.hash}`);}catch(e){alert("Withdraw failed: "+e.message);}
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CHECK + RECLAIM LOGIC (Unified Final) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Track last detected reclaimable deposit hash
let lastReclaimableHash = "";

// CHECK ANY DEPOSIT
document.getElementById("checkBtn").onclick = async () => {
  const h = document.getElementById("checkHashInput").value.trim();
  const res = document.getElementById("checkResult");

  if (!h.startsWith("0x") || h.length !== 66) {
    res.innerHTML = "Invalid hash";
    res.style.display = "block";
    return;
  }

  try {
    const [amt, t, claimed] = await pubShield.deposits(h);
    if (amt.isZero()) {
      res.innerHTML = "No deposit found";
      res.style.display = "block";
      return;
    }

    const amount = Number(ethers.utils.formatUnits(amt, 18)).toFixed(2);
    const exp = Number(t) + 7 * 86400;
    const days = Math.max(0, (exp - Date.now() / 1000) / 86400).toFixed(1);

    let statusHTML;
    if (claimed) {
      statusHTML = `<span class='check-claimed'>Withdrawn</span>`;
    } else if (days <= 0) {
      statusHTML = `<span class='check-expired'>Reclaimable Now (5% bounty)</span>`;
      lastReclaimableHash = h;
    } else {
      statusHTML = `<span class='check-active'>Active ‚Äî ${days} days left</span>`;
    }

    res.innerHTML = `
      <strong>${amount} PRIVX</strong><br>
      Status: ${statusHTML}<br>
      Expires: ${new Date(exp * 1000).toLocaleString()}
    `;
    res.style.display = "block";

    // Auto-fill reclaim tab if reclaimable
    if (days <= 0 && !claimed) autoFillReclaim(h);

  } catch (e) {
    res.innerHTML = "RPC error ‚Äî try again";
    res.style.display = "block";
  }
};

// RECLAIM TAB LOADER (auto-fill if available)
async function loadReclaimTab() {
  const input = document.getElementById("reclaimInput");
  const s = document.getElementById("reclaimStatus");
  if (lastReclaimableHash) {
    input.value = lastReclaimableHash;
    s.textContent = "Detected reclaimable deposit from your last check.";
  } else {
    input.value = "";
    s.textContent = "";
  }
}

// CLAIM FUNCTION (single definitive handler)
async function reclaimDeposit(hash) {
  if (!shield) return alert("Please connect your wallet first.");
  const target = hash || document.getElementById("reclaimInput").value.trim();
  if (!target.startsWith("0x") || target.length !== 66)
    return alert("Invalid deposit hash.");
  const btn = document.getElementById("claimBtn");
  const s = document.getElementById("reclaimStatus");
  btn.disabled = true;
  s.textContent = "Claiming bounty...";
  try {
    const tx = await shield.reclaim(target);
    s.innerHTML = `Waiting confirmation‚Ä¶<br>${tx.hash}`;
    await tx.wait();
    s.innerHTML = `Reclaim successful!<br>
      <a href='https://scan.pulsechain.com/tx/${tx.hash}' target='_blank' style='color:#a78bfa;'>
        View Transaction
      </a>`;
    updateStats();
  } catch (e) {
    s.textContent = "Failed: " + e.message;
  } finally {
    btn.disabled = false;
  }
}

// AUTO-FILL & NAVIGATE TO RECLAIM TAB
function autoFillReclaim(hash) {
  lastReclaimableHash = hash;
  const input = document.getElementById("reclaimInput");
  if (input) input.value = hash;
  setMainTab('reclaim');
  loadReclaimTab();
}

// Default startup
setMainTab("shield");
</script>

<!-- WalletConnect (desktop fallback) -->
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<!-- QR Code Library (required for Ghost Transfer) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- QR CODE GHOST TRANSFER ‚Äî FINAL 100% WORKING VERSION -->
<script>
// Generate QR for secret ‚Äî NOW FULLY RENDERS + DOWNLOAD WORKS
document.getElementById("generateQrBtn")?.addEventListener("click", () => {
  if (!rawSecret) return alert("Generate a secret first!");

  const container = document.getElementById("qrContainer");
  const canvas = document.getElementById("qrCanvas");

  // Show container
  container.style.display = "block";

  // Clear any previous QR
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Generate beautiful purple QR
  QRCode.toCanvas(canvas, rawSecret, {
    width: 320,
    margin: 3,
    color: {
      dark: "#a78bfa",
      light: "#0f1117"
    }
  }, (error) => {
    if (error) console.error(error);
  });

  // Download button ‚Äî now 100% reliable
  document.getElementById("downloadQrBtn").onclick = () => {
    const link = document.createElement("a");
    link.download = `privx-secret-${rawSecret.slice(0, 10)}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
  };
});
</script>

<!-- PWA SERVICE WORKER ‚Äî BULLETPROOF & FINAL -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('PrivX Shield PWA Active ‚Üí', reg.scope);
      })
      .catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
  });
}
</script>

</body>
</html>
