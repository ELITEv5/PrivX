<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PrivX Shield V11 — Private Transfers</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f1117; --card:#171a21; --text:#e2e8f0; --muted:#94a3b8; --primary:#6366f1; --success:#22c55e; --danger:#ef4444; --border:#2d3748; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; line-height:1.6; }
  .container { max-width:460px; margin:2rem auto; padding:0 1rem; }
  header { text-align:center; padding:2.5rem 0 1.5rem; }
  header img { height:96px; border-radius:20px; box-shadow:0 10px 40px rgba(99,102,241,0.5); }
  header h1 { font-size:1.9rem; margin:1rem 0 0.4rem; color:white; font-weight:700; }
  header p { color:var(--muted); font-size:1.05rem; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.6rem; margin:1.6rem 0; }
  .btn { background:var(--primary); color:white; border:none; border-radius:12px; padding:1rem; width:100%; font-weight:600; cursor:pointer; transition:0.2s; font-size:1.1rem; }
  .btn:hover { background:#5558e0; }
  .btn:disabled { background:#334155; cursor:not-allowed; opacity:0.7; }
  .btn-success { background:var(--success); }
  .btn-reclaim { background:#f59e0b; }
  input, textarea { width:100%; padding:1rem; border-radius:12px; border:1px solid var(--border); background:#1e2533; color:white; font-size:1rem; margin:0.6rem 0; box-sizing:border-box; font-family:monospace; }
  .label { display:block; margin:1.4rem 0 0.5rem; font-size:1rem; color:var(--muted); font-weight:500; }
  .critical { background:#7f1d1d; color:#fca5a5; padding:1.2rem; border-radius:12px; margin:1.4rem 0; font-weight:600; text-align:center; font-size:1.05rem; }
  .warning { color:#f59e0b; font-size:0.95rem; margin-top:0.6rem; display:block; }
  .tab { padding:1rem; background:#1e2533; border-radius:12px; cursor:pointer; text-align:center; margin:0.5rem 0; }
  .tab.active { background:var(--primary); color:white; font-weight:600; }
  .highlight { background:#1e4d3d; color:#22c55e; padding:0.8rem; border-radius:8px; margin:1rem 0; font-family:monospace; font-weight:bold; text-align:center; }
  .dashboard-item { background:#1e2533; border-radius:12px; padding:1rem; margin:0.8rem 0; font-size:0.95rem; }
  .countdown { color:#22c55e; font-weight:700; }
  .expired { color:#f59e0b; font-weight:700; }
  .vault-field { background:#2d1b69; border:2px solid #8b5cf6; color:#e0d4ff; }
  .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:1.5rem 0; }
  .stat { background:#1e2533; border-radius:12px; padding:1.2rem; text-align:center; }
  .stat-value { font-size:1.5rem; font-weight:700; color:white; }
  footer { text-align:center; padding:2.5rem; color:#475569; font-size:0.9rem; }
</style>
</head>
<body>
<div class="container">

  <header>
    <img src="PRIVX.png" alt="PrivX Shield">
    <h1>PrivX Shield V11</h1>
    <p>Private • Instant • Irreversible</p>
  </header>

  <!-- MINING VAULT -->
  <div class="card vault-field">
    <div class="label">Mining Vault (5% Reward Pool)</div>
    <input id="miningVaultBalance" readonly style="background:transparent; border:none; font-size:1.4rem; text-align:center; color:#c4b5fd;" />
  </div>

  <!-- LIVE STATS -->
  <div class="stat-grid">
    <div class="stat"><div>Total Burned</div><div id="burnCounter" class="stat-value">—</div></div>
    <div class="stat"><div>In Shield</div><div id="vaultBalance" class="stat-value">—</div></div>
  </div>

  <!-- PERSONAL DASHBOARD -->
  <div class="card">
    <div class="label">Your Active Deposits</div>
    <div id="dashboard" style="max-height:400px; overflow-y:auto;">
      <div style="text-align:center; color:#94a3b8; padding:1rem;">Connect wallet to see your deposits</div>
    </div>
  </div>

  <!-- MODE SELECTOR -->
  <div class="card">
    <div class="label">Choose Your Role</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
      <div class="tab active" id="tabDepositor" onclick="setMode('depositor')">Depositor</div>
      <div class="tab" id="tabReceiver" onclick="setMode('receiver')">Receiver</div>
    </div>
  </div>

  <!-- DEPOSITOR MODE -->
  <div id="depositorSection">
    <div class="card">
      <div class="label">1. Generate Deposit</div>
      <button id="generateDepositBtn" class="btn" disabled>Generate Secret + Hash</button>
      <div id="depositorOutput" style="display:none; margin-top:1rem;">
        <div class="label">Your Secret (send to Receiver)</div>
        <textarea id="secretField" readonly rows="2"></textarea>
        <div class="highlight">Deposit Hash auto-filled below</div>
        <button id="downloadDepositorBackup" class="btn-success" style="margin-top:1rem;">Download Backup</button>
      </div>
    </div>
  </div>

  <!-- RECEIVER MODE -->
  <div id="receiverSection" style="display:none;">
    <div class="card">
      <div class="label">1. Enter Secret</div>
      <textarea id="receiverSecret" rows="2" placeholder="Paste secret here"></textarea>
      <div class="label">2. Your Fresh Wallet</div>
      <input id="receiverWallet" placeholder="0x..." />
      <button id="generateCommitBtn" class="btn" disabled>Generate Commit Hash</button>
      <div id="receiverOutput" style="display:none; margin-top:1rem;">
        <div class="highlight">Commit Hash ready</div>
      </div>
    </div>
  </div>

  <!-- WALLET -->
  <div class="card">
    <button id="connect" class="btn">Connect Wallet</button>
    <button id="disconnect" class="btn" style="display:none;">Disconnect</button>
    <div id="status" style="margin-top:0.8rem; color:var(--muted);"></div>
  </div>

  <!-- DEPOSIT -->
  <div class="card">
    <div class="label">1. Deposit Amount</div>
    <input id="depositAmount" placeholder="e.g. 1000" type="number" step="any" />
    <input id="depositHashField" readonly placeholder="Auto-filled after generation" style="background:#162d20; border-color:#22c55e;" />
    <button id="approveBtn" class="btn" disabled>Approve PRIVX</button>
    <button id="depositBtn" class="btn" style="margin-top:0.6rem;" disabled>Deposit</button>
  </div>

  <!-- COMMIT -->
  <div class="card">
    <div class="label">2. Commit</div>
    <div id="commitHashDisplay" class="highlight" style="display:none;">Commit Hash ready</div>
    <button id="commitBtn" class="btn" disabled>Commit (~13 min wait)</button>
  </div>

  <!-- WITHDRAW -->
  <div class="card">
    <div class="label">3. Withdraw</div>
    <input id="wallet1" placeholder="Fresh wallet 1" />
    <input id="wallet2" placeholder="Fresh wallet 2 (optional)" />
    <input id="wallet3" placeholder="Fresh wallet 3 (optional)" />
    <button id="withdrawBtn" class="btn" disabled>Withdraw (Random Split)</button>
  </div>

  <!-- RECLAIM EXPIRED -->
  <div class="card">
    <div class="label">Reclaim Expired Deposits (5% Reward)</div>
    <button id="reclaimAllBtn" class="btn btn-reclaim" disabled>Reclaim All Expired</button>
  </div>

  <!-- CHECK ANY -->
  <div class="card">
    <div class="label">Check Any Deposit</div>
    <input id="checkHashInput" placeholder="Paste Deposit Hash" />
    <button id="checkBtn" class="btn">Check Status</button>
    <div id="checkResult" style="margin-top:1rem; display:none;"></div>
  </div>

</div>

<footer>
  PrivX Shield V11 • Immutable • 2025<br>
  <a href="https://github.com/ELITEv5/PrivX" style="color:#6366f1;">View Source</a>
</footer>

<script>
const SHIELD = "0xAF4934a35cc3Bed4821d4220baEF4f71B86260B4";
const TOKEN  = "0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986";

let provider, signer, account, shield, token, pubShield;
let rawSecret = "", depositHash = "", commitHash = "";
let myDeposits = [];

const ABI = [
  "function totalBurned() view returns (uint256)",
  "function totalVaultBalance() view returns (uint256)",
  "function miningVault() view returns (address)",
  "function deposits(bytes32) view returns (uint256 amount, uint256 timestamp, bool claimed)",
  "function deposit(uint256 amount, bytes32 secretHash)",
  "function commit(bytes32 commitHash)",
  "function withdraw(string calldata secret, address[] calldata recipients)",
  "function reclaim(bytes32 depositHash)"
];

const pubProvider = new ethers.providers.JsonRpcProvider("https://rpc.pulsechain.com");
pubShield = new ethers.Contract(SHIELD, ABI, pubProvider);

// LIVE STATS + MINING VAULT
async function updateStats() {
  try {
    const [burned, balance, vaultAddr] = await Promise.all([
      pubShield.totalBurned(),
      pubShield.totalVaultBalance(),
      pubShield.miningVault()
    ]);
    document.getElementById("burnCounter").textContent = Number(ethers.utils.formatUnits(burned, 18)).toLocaleString();
    document.getElementById("vaultBalance").textContent = Number(ethers.utils.formatUnits(balance, 18)).toLocaleString();
    
    const vaultBal = await pubProvider.getBalance(vaultAddr);
    document.getElementById("miningVaultBalance").value = `${Number(ethers.utils.formatEther(vaultBal)).toFixed(2)} PLS`;
  } catch (e) {}
}
setInterval(updateStats, 15000);
updateStats();

// PERSONAL DASHBOARD + COUNTDOWN
async function updateDashboard() {
  if (!account) return;
  const container = document.getElementById("dashboard");
  container.innerHTML = "";

  if (myDeposits.length === 0) {
    container.innerHTML = "<div style='text-align:center; color:#94a3b8;'>No active deposits</div>";
    return;
  }

  myDeposits.forEach(d => {
    const now = Date.now() / 1000;
    const expires = d.timestamp + 7*24*60*60;
    const timeLeft = expires - now;

    const item = document.createElement("div");
    item.className = "dashboard-item";
    item.innerHTML = `
      <strong>${d.amount} PRIVX</strong><br>
      Hash: ${d.hash.slice(0,10)}...${d.hash.slice(-8)}<br>
      <span class="${timeLeft > 0 ? 'countdown' : 'expired'}">
        ${timeLeft > 0 ? formatTime(timeLeft) : "EXPIRED — Reclaimable"}
      </span>
      ${timeLeft <= 0 ? `<button onclick="reclaim('${d.hash}')" class="btn-reclaim" style="margin-top:0.5rem; padding:0.5rem; font-size:0.9rem;">Reclaim 5%</button>` : ""}
    `;
    container.appendChild(item);
  });
}

function formatTime(seconds) {
  const d = Math.floor(seconds / 86400);
  const h = Math.floor((seconds % 86400) / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  return `${d}d ${h}h ${m}m`;
}

// SCAN FOR USER'S DEPOSITS (via events — simplified)
async function scanMyDeposits() {
  if (!account) return;
  // In real app: use TheGraph or scan logs
  // For now: placeholder — will be enhanced
  myDeposits = []; // Placeholder
  updateDashboard();
}

// RECLAIM FUNCTION
async function reclaim(hash) {
  try {
    const tx = await shield.reclaim(hash);
    alert(`Reclaim sent! +5% reward\nTx: ${tx.hash}`);
  } catch (e) {
    alert("Reclaim failed: " + e.message);
  }
}

// RECLAIM ALL EXPIRED
document.getElementById("reclaimAllBtn").onclick = async () => {
  const expired = myDeposits.filter(d => (d.timestamp + 7*24*60*60) < Date.now()/1000);
  if (expired.length === 0) return alert("No expired deposits");
  for (const d of expired) await reclaim(d.hash);
};

// REST OF WORKING CODE (connect, generate, deposit, etc.) — unchanged from previous version
// ... [All previous working logic here] ...

setInterval(() => {
  updateDashboard();
  updateStats();
}, 10000);
</script>
</body>
</html>
