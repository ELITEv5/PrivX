<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PrivX Shield — Private Transfers</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f1117; --card:#171a21; --text:#e2e8f0; --muted:#94a3b8; --primary:#6366f1; --success:#22c55e; --danger:#ef4444; --border:#2d3748; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; line-height:1.6; }
  .container { max-width:440px; margin:2rem auto; padding:0 1rem; }
  header { text-align:center; padding:2.5rem 0 1.5rem; }
  header img { height:88px; border-radius:16px; box-shadow:0 8px 30px rgba(99,102,241,0.4); }
  header h1 { font-size:1.8rem; margin:1rem 0 0.4rem; color:white; font-weight:700; }
  header p { color:var(--muted); font-size:1rem; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.6rem; margin:1.6rem 0; }
  .btn { background:var(--primary); color:white; border:none; border-radius:12px; padding:1rem; width:100%; font-weight:600; cursor:pointer; transition:0.2s; font-size:1.05rem; }
  .btn:hover { background:#5558e0; }
  .btn:disabled { background:#334155; cursor:not-allowed; opacity:0.7; }
  .btn-success { background:var(--success); }
  .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text); }
  input, textarea { width:100%; padding:1rem; border-radius:12px; border:1px solid var(--border); background:#1e2533; color:white; font-size:1rem; margin:0.6rem 0; box-sizing:border-box; font-family:monospace; }
  .label { display:block; margin:1.4rem 0 0.5rem; font-size:1rem; color:var(--muted); font-weight:500; }
  .critical { background:#7f1d1d; color:#fca5a5; padding:1.2rem; border-radius:12px; margin:1.4rem 0; font-weight:600; text-align:center; font-size:1.05rem; }
  .warning { color:#f59e0b; font-size:0.95rem; margin-top:0.6rem; display:block; }
  .mode-tabs { display:flex; gap:1rem; margin-bottom:1rem; }
  .tab { flex:1; padding:1rem; text-align:center; background:#1e2533; border-radius:12px; cursor:pointer; transition:0.2s; }
  .tab.active { background:var(--primary); color:white; font-weight:600; }
  .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:1.5rem 0; }
  .stat { background:#1e2533; border-radius:12px; padding:1.2rem; text-align:center; }
  .stat-value { font-size:1.5rem; font-weight:700; color:white; }
  footer { text-align:center; padding:2.5rem; color:#475569; font-size:0.9rem; }
</style>
</head>
<body>
<div class="container">

  <header>
    <img src="PRIVX.png" alt="PrivX Shield">
    <h1>PrivX Shield</h1>
    <p>Private transfers on PulseChain • V11</p>
  </header>

  <!-- MODE SELECTOR -->
  <div class="card">
    <div class="label">Choose Your Role</div>
    <div class="mode-tabs">
      <div class="tab active" id="tabDepositor" onclick="switchMode('depositor')">Depositor (Sender)</div>
      <div class="tab" id="tabReceiver" onclick="switchMode('receiver')">Receiver</div>
    </div>
  </div>

  <!-- DEPOSITOR MODE -->
  <div id="depositorMode">
    <div class="card">
      <div class="label">1. Generate Deposit (Depositor)</div>
      <button id="generateDepositBtn" class="btn" disabled>Generate Secret + Deposit Hash</button>

      <div id="depositOutput" style="display:none; margin-top:1.2rem;">
        <div class="label">Your Secret (send securely to Receiver)</div>
        <textarea id="secretField" readonly rows="2"></textarea>

        <div class="label">Deposit Hash (use below in Step 1)</div>
        <input id="depositHash" readonly />

        <button id="downloadDepositBackup" class="btn-success" style="margin-top:1rem;">
          Download Backup — REQUIRED
        </button>

        <div class="critical">
          Send the Secret to the Receiver<br>
          They will use it to withdraw privately
        </div>
      </div>
    </div>
  </div>

  <!-- RECEIVER MODE -->
  <div id="receiverMode" style="display:none;">
    <div class="card">
      <div class="label">1. Enter Secret from Depositor</div>
      <textarea id="receiverSecret" rows="2" placeholder="Paste the secret you received"></textarea>

      <div class="label">2. Your Fresh Wallet (for withdrawal)</div>
      <input id="receiverWallet" placeholder="0x..." />

      <button id="generateCommitBtn" class="btn" disabled>Generate Commit Hash</button>

      <div id="commitOutput" style="display:none; margin-top:1.2rem;">
        <div class="label">Commit Hash (use in Step 2 below)</div>
        <input id="commitHash" readonly />

        <div class="critical">
          You now have the Commit Hash<br>
          Use it in Step 2 → Commit → then Withdraw
        </div>
      </div>
    </div>
  </div>

  <!-- WALLET CONNECT -->
  <div class="card">
    <button id="connect" class="btn">Connect Wallet</button>
    <button id="disconnect" class="btn-outline" style="display:none; margin-top:0.6rem;">Disconnect</button>
    <div id="status" style="margin-top:0.8rem; color:var(--muted); font-size:0.95rem;"></div>
  </div>

  <!-- STATS -->
  <div class="stat-grid">
    <div class="stat"><div>Total Burned</div><div id="burnCounter" class="stat-value">—</div></div>
    <div class="stat"><div>In Shield</div><div id="vaultBalance" class="stat-value">—</div></div>
  </div>

  <!-- DEPOSIT -->
  <div class="card">
    <div class="label">1. Deposit Amount</div>
    <input id="depositAmount" placeholder="e.g. 1000" type="number" />
    <button id="approveBtn" class="btn" disabled>Approve PRIVX</button>
    <button id="depositBtn" class="btn" style="margin-top:0.6rem;" disabled>Deposit</button>
  </div>

  <!-- COMMIT -->
  <div class="card">
    <div class="label">2. Commit (Privacy Lock)</div>
    <button id="commitBtn" class="btn" disabled>Commit Hash (~13 min wait)</button>
  </div>

  <!-- WITHDRAW -->
  <div class="card">
    <div class="label">3. Withdraw Privately</div>
    <input id="wallet1" placeholder="Fresh wallet 1" />
    <input id="wallet2" placeholder="Fresh wallet 2 (optional)" />
    <input id="wallet3" placeholder="Fresh wallet 3 (optional)" />
    <button id="withdrawBtn" class="btn" disabled>Withdraw (Random Split)</button>
    <small class="warning">Use brand-new wallets only</small>
  </div>

  <!-- RECLAIM + CHECK -->
  <div class="card">
    <div class="label">Reclaim Expired (5% reward)</div>
    <input id="reclaimHash" placeholder="Deposit hash" />
    <button id="reclaimBtn" class="btn" disabled>Reclaim</button>
  </div>

  <div class="card">
    <div class="label">Check Deposit</div>
    <input id="checkHash" placeholder="Deposit hash" />
    <button id="checkBtn" class="btn">Check Status</button>
    <div id="checkResult" style="margin-top:1rem; color:var(--muted);"></div>
  </div>

</div>

<footer>
  PrivX Shield V11 • Immutable • No Admin Keys • 2025<br>
  <a href="https://github.com/ELITEv5/PrivX" style="color:#6366f1;">View Source</a>
</footer>

<script>
// STATE
const SHIELD = "0xAF4934a35cc3Bed4821d4220baEF4f71B86260B4";
const TOKEN  = "0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986";
let provider, signer, account, shield, token, pubShield;
let rawSecret = "", depositHash = "", commitHash = "";

function switchMode(mode) {
  document.getElementById("depositorMode").style.display = mode === "depositor" ? "block" : "none";
  document.getElementById("receiverMode").style.display = mode === "receiver" ? "block" : "none";
  document.getElementById("tabDepositor").classList.toggle("active", mode === "depositor");
  document.getElementById("tabReceiver").classList.toggle("active", mode === "receiver");
  document.getElementById("depositOutput").style.display = "none";
  document.getElementById("commitOutput").style.display = "none";
}

async function connect() {
  if (!window.ethereum) return alert("MetaMask required");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  const net = await provider.getNetwork();
  if (net.chainId !== 369) return alert("Switch to PulseChain");

  document.getElementById("status").textContent = `Connected: ${account.slice(0,8)}…${account.slice(-6)}`;
  document.getElementById("connect").style.display = "none";
  document.getElementById("disconnect").style.display = "block";

  const abi = await fetch("abi.json").then(r=>r.json());
  shield = new ethers.Contract(SHIELD, abi, signer);
  token = new ethers.Contract(TOKEN, ["function approve(address,uint256)"], signer);

  document.getElementById("generateDepositBtn").disabled = false;
}
document.getElementById("connect").onclick = connect;
document.getElementById("disconnect").onclick = () => location.reload();

// DEPOSITOR: Generate Secret + Deposit Hash
document.getElementById("generateDepositBtn").onclick = () => {
  const bytes = crypto.getRandomValues(new Uint8Array(32));
  rawSecret = Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");

  depositHash = ethers.utils.keccak256(
    ethers.utils.defaultAbiCoder.encode(["string"], [rawSecret])
  );

  document.getElementById("secretField").value = rawSecret;
  document.getElementById("depositHash").value = depositHash;
  document.getElementById("depositOutput").style.display = "block";

  document.getElementById("downloadDepositBackup").onclick = () => {
    const blob = new Blob([`PRIVX SHIELD V11 — DEPOSITOR BACKUP

Secret (send to Receiver):
${rawSecret}

Deposit Hash:
${depositHash}

Amount: ${document.getElementById("depositAmount").value || "Not set"}

Generated: ${new Date().toLocaleString()}
`], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "privx-depositor-backup.txt"; a.click();

    document.querySelectorAll("#approveBtn,#depositBtn").forEach(b => b.disabled = false);
  };
};

// RECEIVER: Generate Commit Hash
document.getElementById("receiverSecret").oninput =
document.getElementById("receiverWallet").oninput = () => {
  const secret = document.getElementById("receiverSecret").value.trim();
  const wallet = document.getElementById("receiverWallet").value.trim();
  document.getElementById("generateCommitBtn").disabled = !(secret && ethers.utils.isAddress(wallet));
};

document.getElementById("generateCommitBtn").onclick = () => {
  const secret = document.getElementById("receiverSecret").value.trim();
  commitHash = ethers.utils.keccak256(
    ethers.utils.solidityPack(["string", "address"], [secret, account])
  );
  document.getElementById("commitHash").value = commitHash;
  document.getElementById("commitOutput").style.display = "block";

  document.getElementById("commitBtn").disabled = false;
  document.getElementById("withdrawBtn").disabled = false;
  rawSecret = secret; // for withdrawal
};

// Stats + Actions (same as before)
const pub = new ethers.providers.JsonRpcProvider("https://rpc.pulsechain.com");
(async () => {
  const abi = await fetch("abi.json").then(r=>r.json());
  pubShield = new ethers.Contract(SHIELD, abi, pub);
  const update = async () => {
    const [burned, bal] = await Promise.all([pubShield.totalBurned(), pubShield.totalVaultBalance()]);
    document.getElementById("burnCounter").textContent = Number(ethers.utils.formatUnits(burned,18)).toFixed(0);
    document.getElementById("vaultBalance").textContent = Number(ethers.utils.formatUnits(bal,18)).toFixed(0);
  };
  update(); setInterval(update, 30000);
})();

document.getElementById("approveBtn").onclick = async () => { const tx = await token.approve(SHIELD, ethers.constants.MaxUint256); alert("Approval: " + tx.hash); };
document.getElementById("depositBtn").onclick = async () => { const amt = ethers.utils.parseUnits(document.getElementById("depositAmount").value || "0", 18); const tx = await shield.deposit(amt, depositHash); alert("Deposit: " + tx.hash); };
document.getElementById("commitBtn").onclick = async () => { const tx = await shield.commit(commitHash); alert("Commit: " + tx.hash); };
document.getElementById("withdrawBtn").onclick = async () => {
  const wallets = ["wallet1","wallet2","wallet3"].map(id=>document.getElementById(id).value.trim()).filter(a=>ethers.utils.isAddress(a));
  if (!wallets.length) return alert("Add at least one wallet");
  const tx = await shield.withdraw(rawSecret, wallets);
  alert("Private withdrawal sent: " + tx.hash);
};
document.getElementById("reclaimBtn").onclick = async () => { const h = document.getElementById("reclaimHash").value; const tx = await shield.reclaim(h); alert("Reclaim: " + tx.hash); };
document.getElementById("checkBtn").onclick = async () => {
  const h = document.getElementById("checkHash").value;
  const d = await pubShield.deposits(h);
  if (d.amount.isZero()) return document.getElementById("checkResult").textContent = "Not found";
  const amt = ethers.utils.formatUnits(d.amount,18);
  document.getElementById("checkResult").textContent = `${amt} PRIVX • ${d.claimed ? "Withdrawn" : "Active"}`;
};
</script>
</body>
</html>
