<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PrivX Shield Relay â€” Official Helper V10 â€œProof of Privacy Editionâ€</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- PWA Manifest Link -->
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0ff1c0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PrivX">
<!-- PWA Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered'))
      .catch(err => console.warn('SW failed', err));
  }
</script>
<!-- PWA Install Button + Smart Trigger -->
<button id="installButton" style="display:none;background:#0ff1c0;color:black;padding:14px 24px;border:none;border-radius:12px;font-weight:bold;margin:20px auto;font-size:1.1rem;" onclick="installPWA()">
  Install PrivX Shield App
</button>
<script>
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installButton').style.display = 'block';
});
document.getElementById('connect')?.addEventListener('click', () => {
  setTimeout(() => {
    if (deferredPrompt) document.getElementById('installButton').style.display = 'block';
  }, 1000);
});
function installPWA() {
  if (!deferredPrompt) {
    alert("Install via Chrome menu â†’ Add to Home screen");
    return;
  }
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(() => deferredPrompt = null);
}
</script>
<style>
  /* â†â†â† THIS MUST BE FIRST â€” fixes invisible button bug is now dead */
  .neon-btn{background:#5c00ff;color:#fff;border:none;border-radius:8px;padding:0.7rem 1.2rem;margin:0.4rem;cursor:pointer;font-size:1rem;transition:0.2s;box-shadow:0 0 12px rgba(91,0,255,0.5);}
  .neon-btn:hover{background:#6f14ff;box-shadow:0 0 28px rgba(91,0,255,0.8);}
  .neon-btn:disabled{background:#333;opacity:0.6;cursor:not-allowed;box-shadow:none;}
  body{font-family:system-ui,sans-serif;background:#0a0a0a;color:#eee;text-align:center;padding:2rem;max-width:900px;margin:auto}
  h1{color:#8b5cf6;font-size:2rem;margin-bottom:.3rem;display:flex;align-items:center;justify-content:center;gap:.5rem}
  h1 img{width:48px;filter:drop-shadow(0 0 10px #8b5cf6);animation:logoGlow 3s infinite alternate;}
  @keyframes logoGlow{from{filter:drop-shadow(0 0 6px #8b5cf6);}to{filter:drop-shadow(0 0 20px #8b5cf6);}}
  h3{color:#00ffcc}
  a{color:#8b5cf6;text-decoration:none}
  a:hover{text-decoration:underline;color:#a36fff}
  button{background:#5c00ff;color:#fff;padding:.6rem 1rem;border:none;border-radius:8px;font-size:1rem;cursor:pointer;margin:.3rem;transition:.2s}
  button:hover{background:#6f14ff}
  button:disabled{background:#333;cursor:not-allowed}
  input{width:90%;max-width:420px;margin:.3rem 0;padding:.6rem;border-radius:8px;border:none;font-size:1rem;text-align:center;background:#161616;color:#00ffcc}
  .section{border:1px solid #222;border-radius:12px;padding:1.3rem;margin:1.5rem 0;background:#111}
  #status{margin-bottom:1rem;color:#f55;font-weight:bold}
  footer{margin-top:2rem;font-size:.9rem;color:#777}
  small{color:#aaa;display:block;margin-top:.5rem}
  .warning{color:#ffcc00}
  hr{border:none;border-top:1px solid #333;margin:1.5rem 0}
  .ca-box{background:#161616;padding:0.6rem;border-radius:8px;margin:0.3rem 0;word-break:break-all}
  .ca-copy{background:#333;color:#00ffcc;border:none;border-radius:6px;padding:0.3rem 0.7rem;cursor:pointer;font-size:0.85rem;margin-left:0.4rem;}
  .ca-copy:hover{background:#555;}
  .explainer{background:#141414;border-left:5px solid #8b5cf6;padding:1rem;border-radius:8px;text-align:left;line-height:1.5em;margin-bottom:1.5rem;}
  .hashList{background:#0f0f0f;border-radius:10px;padding:1rem;margin-top:1rem;text-align:left;max-height:220px;overflow-y:auto;}
  .timer-glow{color:#ffcc00;text-shadow:0 0 10px #ffcc00,0 0 20px #ffaa00;animation:pulseGlow 2s infinite alternate;}
  @keyframes pulseGlow{from{text-shadow:0 0 10px #ffcc00,0 0 20px #ffaa00;}to{text-shadow:0 0 20px #ffaa00,0 0 40px #ff8800;}}
  .feed{background:#0d0d0d;border:1px solid #222;border-radius:10px;padding:1rem;margin-top:1rem;text-align:left;max-height:180px;overflow-y:auto;}
  .glow{color:#8b5cf6;text-shadow:0 0 10px #8b5cf6,0 0 20px #5c00ff;}
  .wallet-guide{display:none;background:#141414;border:1px solid #222;border-radius:10px;padding:1rem;margin-top:0.8rem;text-align:left;color:#ccc;line-height:1.6em;}
</style>
</head>
<body>
<!-- PRIVX HEADER â€” BIG GLOWING LOGO FIXED -->
<div style="text-align:center;margin:2rem 0;">
  <img src="PRIV.png" alt="PrivX Shield" style="width:90%;max-width:560px;height:auto;filter:drop-shadow(0 0 20px #8b5cf6);animation:logoGlow 4s infinite alternate;" />
  <h1 style="color:#8b5cf6;font-size:2rem;margin:0.8rem 0 0.4rem 0;text-shadow:0 0 15px #8b5cf6;">
    PrivX Shield Relay â€” V10 â€œProof of Privacy Editionâ€
  </h1>
  <p style="color:#00ffcc;font-size:1.1rem;margin:0.3rem 0;">Built by Elite Team6 â€¢ 2025</p>
</div>
<style>
@keyframes logoGlow {
  from { filter: drop-shadow(0 0 10px #8b5cf6); }
  to { filter: drop-shadow(0 0 30px #8b5cf6) drop-shadow(0 0 50px #5c00ff);27
}
@media (max-width: 600px) {
  div[style*="text-align:center"] img { max-width: 340px; }
}
</style>
<!-- ğŸ”— WALLET CONNECTION -->
<div id="walletConnect" style="margin:1.2rem 0;">
  <button id="connect">ğŸ”— Connect Wallet</button>
  <button id="disconnect" style="display:none;">âŒ Disconnect</button>
  <div id="status" style="margin-top:0.5rem;color:#aaa;">Not connected</div>
  <small style="color:#777;">Required for deposits, commits, and withdrawals.</small>
</div>
<!-- ğŸŒ WHY PRIVX SECTION -->
<div class="explainer" id="why-privx">
  <h3 style="color:#00ffcc;">ğŸŒ Why PrivX Exists â€” Privacy That Accelerates With Participation</h3>
  <p><b>PrivX isnâ€™t about hiding â€” itâ€™s about blending in faster.</b></p>
  <p>Modern blockchains are transparent by design. Every wallet, every transfer, every pattern is visible forever.
     <b>PrivX</b> transforms this transparency into a collective privacy shield, powered by mathematics â€” not secrecy.</p>
  <hr>
  <h4 style="color:#00ffcc;">ğŸ§  The Core Mechanism</h4>
  <p>Each deposit in the Shield Relay is locked under a <code>keccak256(secret)</code> hash.
     The <b>secret</b> remains private, while the <b>hash</b> becomes your on-chain proof.
     When you or a recipient reveal the secret to withdraw, it matches the stored hash and releases the tokens.</p>
  <p>As hundreds or thousands of users do this â€” at different times and with different amounts â€”
     it becomes statistically impossible to know which deposit maps to which withdrawal.</p>
  <hr>
  <h4 style="color:#00ffcc;">ğŸ•¶ï¸ Stealth Withdraw Layer</h4>
  <p>V10 introduces a <b>Commitâ€“Reveal stealth layer</b> that protects your withdrawal from mempool front-running.
     Before you withdraw, you must first <b>commit</b> your withdrawal secret hash â€” this quietly signals intent without revealing any data.
     After a short window (~5 minutes), you can <b>reveal</b> your secret to finalize the withdrawal.
     This ensures your action cannot be copied, traced, or intercepted while pending in the mempool.</p>
  <blockquote style="border-left:3px solid #8b5cf6;padding-left:1rem;margin:1rem 0;color:#ccc;">
    â€œYour withdrawal vanishes before it appears â€” stealth by design.â€
  </blockquote>
  <h4 style="color:#00ffcc;">ğŸ•“ The 7-Day Obfuscation Window</h4>
  <p>Every deposit remains locked for up to 7 days.
     This period forms a temporal privacy field â€” no one can tell <i>when</i> a deposit and withdrawal are linked.
     As hundreds of users deposit and withdraw at varying times within this rolling window,
     the transactional entropy increases, and linkability collapses into statistical noise.</p>
</div>
<!-- ğŸ’ PROOF OF PRIVACY MINING VAULT -->
<div class="section" style="background:#121212;">
  <h3>ğŸ’ Proof-of-Privacy Mining Vault â€” Earn While Shielding</h3>
  <p>With V10, every deposit doesnâ€™t just strengthen privacy â€” it <b>mines</b> new PRIVX directly from the immutable <b>Proof-of-Privacy Mine Vault</b>.</p>
  <ul style="text-align:left;line-height:1.6em;">
    <li>âš’ï¸ <b>Automatic Rewards:</b> Each valid deposit triggers <code>mintReward()</code> from the Vault.</li>
    <li>ğŸ’  <b>70 % to you</b> â€” sent instantly to your wallet.</li>
    <li>ğŸ”¥ <b>30 % burned</b> â€” removed forever, tightening total supply.</li>
    <li>ğŸ“‰ <b>Decay Logic:</b> Rewards slowly shrink as the vault depletes, rewarding early privacy miners.</li>
    <li>ğŸ”’ <b>Sealed Forever:</b> Once 2.1 M PRIVX are distributed, the vault locks â€” no admin, no reset, no backdoor.</li>
    <li>ğŸ’¡ <b>Minimum for reward:</b> 25 PRIVX â€” smaller deposits still count toward privacy strength but do not generate mining rewards.</li>
  </ul>
  <p style="color:#8b5cf6;font-weight:bold;margin-top:.8rem;">
    â€œEvery deposit mines privacy itself â€” the more you shield, the rarer PRIVX becomes.â€
  </p>
</div>
<!-- ğŸ“œ OFFICIAL CONTRACT ADDRESSES -->
<div class="section" style="background:#141414;">
  <h3>ğŸ“œ Official Contract Addresses</h3>
  <div class="ca-box">
    ğŸ’  <b>PRIVX Token</b><br>
    <code id="caToken">0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986</code>
    <button class="ca-copy" onclick="copyCA('caToken')">Copy</button><br>
    <a href="https://scan.pulsechain.com/address/0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986" target="_blank">
      View on PulseChainScan â†—
    </a>
  </div>
  <div class="ca-box">
    ğŸ›¡ï¸ <b>PrivX Shield Relay V10 â€” Mine Edition</b><br>
    <code id="caRelay">0x2F7fc6d09A9A3a5766CF06386c92a099351c64B6</code>
    <button class="ca-copy" onclick="copyCA('caRelay')">Copy</button><br>
    <a href="https://scan.pulsechain.com/address/0x2F7fc6d09A9A3a5766CF06386c92a099351c64B6" target="_blank">
      View on PulseChainScan â†—
    </a>
  </div>
  <div class="ca-box">
    ğŸ’ <b>PrivX Proof-of-Privacy Mine Vault</b><br>
    <code id="caVault">0x8Cfd5090fab215Fb4aE5ef01EDD5D64baCd4B5fB</code>
    <button class="ca-copy" onclick="copyCA('caVault')">Copy</button><br>
    <a href="https://scan.pulsechain.com/address/0x8Cfd5090fab215Fb4aE5ef01EDD5D64baCd4B5fB" target="_blank">
      View on PulseChainScan â†—
    </a>
  </div>
  <small style="display:block;margin-top:.8rem;color:#aaa;">
    ğŸ§© Verified Contracts â€¢ No Admin â€¢ No Upgrades â€¢ 100% On-Chain Autonomy
  </small>
</div>
<!-- ğŸ”¥ TOTAL PRIVX BURNED -->
<div class="section" style="background:#121212;">
  <h3>ğŸ”¥ Total PRIVX Burned</h3>
  <h2 id="burnCounter" class="glow">Loading...</h2>
  <small id="burnUpdate">â³ Fetching on-chain dataâ€¦</small>
</div>
<!-- ğŸ”’ VAULT TRACKER -->
<div class="section" style="background:#121212;">
  <h3>ğŸ”’ Shield Vault Tracker</h3>
  <p>Total PRIVX held by the Shield Relay (User Deposits):</p>
  <h2 id="vaultBalance" style="color:#00ff99;font-weight:bold;">Loading...</h2>
  <small id="vaultUpdate">â³ Waiting for dataâ€¦</small>
</div>
<!-- ğŸ† MOST COMMON DEPOSIT AMOUNTS -->
<div class="section" style="background:#121212;">
  <h3>ğŸ† Most Common Deposit Amounts</h3>
  <p>The most frequent deposit sizes â€” matching them strengthens your anonymity set.</p>
  <div id="topDeposits">â³ Loading dataâ€¦</div>
  <small style="color:#777;">Privacy Tip: Use popular amounts for better blending.</small>
</div>
<!-- ğŸª™ MINE VAULT LIVE STATS -->
<div class="section" style="background:#121212;">
  <h3>ğŸ¦ Proof-of-Privacy Mine Vault Status</h3>
  <ul style="text-align:left;line-height:1.5em;">
    <li>ğŸ’ Total Distributed: <span id="vaultDistributed" style="color:#00ffcc;">Loadingâ€¦</span></li>
    <li>ğŸ’  Remaining Rewards: <span id="vaultRemaining" style="color:#8b5cf6;">Loadingâ€¦</span></li>
    <li>ğŸ§­ Decay Factor: <span id="vaultDecay" style="color:#ffcc00;">Loadingâ€¦</span></li>
    <li>ğŸ”’ Vault Status: <span id="vaultSealed" style="color:#ff6666;">Loadingâ€¦</span></li>
  </ul>
  <small style="color:#777;">Auto-updates every 30 s from chain.</small>
</div>
<!-- ğŸ›¡ï¸ NETWORK PRIVACY FIELD -->
<div class="section" style="background:#121212;">
  <h3>ğŸ›¡ï¸ Shield Strength (Network Privacy Field)</h3>
  <p>Tracks deposits, burns, and activity â€” privacy grows with participation.</p>
  <h2 id="networkActivity" class="glow-pulse">Loading...</h2>
  <small id="networkStatusMsg" style="display:block;margin-top:.5rem;color:#aaa;">Initializing shield fieldâ€¦</small>
  <div id="shieldFeed" class="feed" style="margin-top:1rem;text-align:left;">
    <div class="feed-entry">System booted â€” monitoring shield events.</div>
  </div>
  <small id="networkUpdate">â³ Fetching on-chain dataâ€¦</small>
</div>
<!-- CORRECT ONE-TAP FLOW â€” WITH SAVE + WARNING -->
<div class="section">
  <h3>Shield Your PRIVX â€” Deposit Flow</h3>
  <p style="color:#00ffcc;font-weight:bold;">Tap once â†’ generate â†’ SAVE before doing anything else!</p>

  <!-- Unsaved Warning Banner -->
  <div id="unsavedWarning" style="display:none;background:#ff3300;color:#fff;padding:1rem;border-radius:10px;margin:1rem 0;font-weight:bold;text-align:center;">
    âš ï¸ You have an unsaved Secret! Save or copy it now â€” generating a new one will delete it forever!
    <button onclick="document.getElementById('unsavedWarning').style.display='none'" style="margin-left:10px;background:#fff;color:#000;padding:0.4rem 0.8rem;border:none;border-radius:6px;">Dismiss</button>
  </div>

  <div style="background:#121212;border-radius:12px;padding:1.5rem;margin:1.5rem 0;border:1px solid #222;">
    
    <button id="autoGenerate" class="neon-btn" style="background:#00ff88;color:#000;font-weight:bold;padding:1rem 2rem;font-size:1.2rem;">
      Generate Secret + Deposit Hash
    </button>

    <div style="margin-top:1.5rem;background:#111;padding:1.2rem;border-radius:10px;line-height:1.7;">
      <div><b>Your Secret (SAVE THIS NOW):</b><br>
        <input id="masterSecret" readonly style="width:100%;margin-top:0.5rem;background:#222;color:#ffcc00;" /></div>
      
      <div style="margin-top:1rem;"><b>Deposit Hash (use to deposit):</b><br>
        <span id="liveDepositHash" style="color:#00ffcc;word-break:break-all;">â€”</span></div>
    </div>

    <!-- Save & Copy Buttons -->
    <div style="margin-top:1rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <button id="saveSecretBtn" disabled class="neon-btn" style="background:#00ff99;color:#000;font-weight:bold;">
        Save as .txt (Recommended)
      </button>
      <button id="copySecretBtn" disabled class="neon-btn" style="background:#3366ff;">
        Copy Secret + Hash
      </button>
    </div>

    <div style="margin-top:1rem;padding:1rem;background:#141414;border-left:4px solid #8b5cf6;border-radius:8px;text-align:left;font-size:0.94rem;">
      <b>Next steps:</b><br>
      1. Save your Secret (click button above)<br>
      2. Deposit using the hash below<br>
      3. Send Secret securely to withdrawer
    </div>
  </div>

  <!-- FINAL DEPOSIT FLOW â€” WITH BRANDED QR CODE + SAVE + WARNING -->
<div class="section">
  <h3>Shield Your PRIVX â€” Deposit Flow</h3>
  <p style="color:#00ffcc;font-weight:bold;">Generate â†’ SAVE â†’ SEND via QR (your friend just scans!)</p>

  <!-- Unsaved Warning -->
  <div id="unsavedWarning" style="display:none;background:#ff3300;color:#fff;padding:1rem;border-radius:10px;margin:1rem 0;font-weight:bold;text-align:center;">
    âš ï¸ UNSAVED SECRET! Save or scan the QR code before generating a new one!
    <button onclick="document.getElementById('unsavedWarning').style.display='none'" style="margin-left:10px;background:#fff;color:#000;padding:0.4rem 0.8rem;border:none;border-radius:6px;">Dismiss</button>
  </div>

  <div style="background:#121212;border-radius:12px;padding:1.5rem;margin:1.5rem 0;border:1px solid #222;">
    
    <button id="autoGenerate" class="neon-btn" style="background:#00ff88;color:#000;font-weight:bold;padding:1rem 2rem;font-size:1.2rem;">
      Generate Secret + Deposit Hash
    </button>

    <div style="margin-top:1.5rem;background:#111;padding:1.2rem;border-radius:10px;line-height:1.7;">
      <div><b>Your Secret (keep private):</b><br>
        <input id="masterSecret" readonly style="width:100%;margin-top:0.5rem;background:#222;color:#ffcc00;" /></div>
      
      <div style="margin-top:1rem;"><b>Deposit Hash:</b><br>
        <span id="liveDepositHash" style="color:#00ffcc;word-break:break-all;">â€”</span></div>

      <!-- QR CODE WITH PRIVX LOGO -->
      <div style="margin-top:1.5rem;text-align:center;">
        <div id="qrContainer" style="display:none;margin:1rem auto;">
          <img id="qrLogo" src="PRIV.png" style="width:64px;height:64px;position:absolute;margin-left:-32px;margin-top:-32px;left:50%;top:50%;pointer-events:none;filter:drop-shadow(0 0 10px #8b5cf6);" />
          <canvas id="qrCanvas"></canvas>
        </div>
        <p id="qrHint" style="display:none;color:#8b5cf6;font-weight:bold;">â†‘ Scan with your friendâ€™s phone â†‘</p>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top:1rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <button id="saveSecretBtn" disabled class="neon-btn" style="background:#00ff99;color:#000;font-weight:bold;">
        Save as .txt
      </button>
      <button id="copySecretBtn" disabled class="neon-btn" style="background:#3366ff;">
        Copy Secret + Hash
      </button>
      <button id="saveQRBtn" disabled class="neon-btn" style="background:#ff00aa;color:#fff;">
        Save QR Code
      </button>
    </div>

    <div style="margin-top:1rem;padding:1rem;background:#141414;border-left:4px solid #8b5cf6;border-radius:8px;text-align:left;font-size:0.94rem;">
      <b>Send to friend:</b><br>
      â€¢ Show them this QR code<br>
      â€¢ Or send the .txt file<br>
      â€¢ Or copy-paste the secret
    </div>
  </div>

  <!-- Deposit inputs -->
  <input id="depositAmount" placeholder="Amount to deposit (e.g. 100)" style="margin:1rem 0;"/>
  <div style="position:relative;">
    <input id="depositHash" readonly placeholder="Deposit Hash (auto-filled)" style="background:#222;color:#00ffcc;width:100%;padding-right:70px;"/>
    <button onclick="navigator.clipboard.writeText(document.getElementById('depositHash').value);alert('Copied!')" 
            style="position:absolute;right:5px;top:50%;transform:translateY(-50%);background:#333;padding:0.4rem 0.6rem;font-size:0.8rem;">Copy</button>
  </div>

  <div style="margin:1.5rem 0;">
    <button id="approveBtn">Approve PRIVX</button>
    <button id="depositBtn">Deposit to Shield</button>
  </div>
</div>
<!-- WITHDRAWER SECTION â€” Correct Logic -->
<div class="section" style="background:#161616;">
  <h3>Withdrawer: Generate Your Commit Hash</h3>
  <p>Paste the Secret you received + your fresh wallet address</p>
  <input id="withdrawSecret" placeholder="Secret (received from depositor)" style="margin:0.5rem 0;"/>
  <input id="withdrawWallet" placeholder="Your fresh wallet address (0x...)" style="margin:0.5rem 0;"/>
 
  <button id="generateCommit" class="neon-btn" style="background:#ff006e;">
    Generate Commit Hash
  </button>
  <div style="margin-top:1rem;">
    <div style="position:relative;">
      <input id="commitHashInput" readonly placeholder="Commit Hash (auto-filled)" style="background:#222;color:#8b5cf6;width:100%;padding-right:70px;"/>
      <button onclick="navigator.clipboard.writeText(document.getElementById('commitHashInput').value);alert('Copied!')" 
              style="position:absolute;right:5px;top:50%;transform:translateY(-50%);background:#333;padding:0.4rem 0.6rem;font-size:0.8rem;">Copy</button>
    </div>
  </div>
  <button id="commitBtn" style="margin-top:1rem;">Commit Stealth</button>
  <small style="color:#ffcc00;">After committing â†’ wait ~5 mins â†’ withdraw to this wallet</small>
</div>
<!-- ğŸ’ STEP 3 â€” WITHDRAW -->
<div class="section">
  <h3>ğŸ’ Withdraw Funds (Stealth Mode)</h3>
  <p>After committing, withdraw to up to 3 wallets.</p>
  <input id="withdrawSecret" placeholder="Secret (UTF-8 string)" /><br/>
  <input id="wallet1" placeholder="Wallet 1 (0xâ€¦)" /><br/>
  <input id="wallet2" placeholder="Wallet 2 (optional)" /><br/>
  <input id="wallet3" placeholder="Wallet 3 (optional)" /><br/>
  <button id="withdrawBtn">ğŸ’ Withdraw (Stealth Mode)</button>
  <small class="warning">ğŸ”’ Use fresh wallets for max privacy.</small>
  <small class="warning">âš ï¸ Anyone with your Secret can withdraw within 7 days â€” keep it safe.</small>
</div>
<!-- ğŸ”¥ RECLAIM -->
<div class="section">
  <h3>ğŸ”¥ Reclaim Expired Deposits</h3>
  <p>After 7 days, anyone can reclaim unclaimed deposits using their hash.</p>
  <input id="reclaimHash" placeholder="Deposit Hash (0xâ€¦)" /><br/>
  <button id="reclaimBtn">ğŸ”¥ Reclaim</button>
  <small>ğŸ’ Reclaim rewards 5 % to the caller â€¢ 95 % burned forever ğŸ”¥</small>
</div>
<!-- ğŸ§© CLAIM HELPER -->
<div class="section" style="background:#161616;">
  <h3>ğŸ§© Claim Helper â€” Find Unclaimed Deposits</h3>
  <p>View all expired deposits ready to reclaim. Copy or reclaim directly below.</p>
  <button id="loadReclaimable">ğŸ” Load Reclaimable Hashes</button>
  <div id="reclaimList" class="hashList">Press to viewâ€¦</div>
  <small>Auto-refreshes every 30 seconds â€¢ View-only â€¢ No wallet needed.</small>
</div>
<!-- ğŸ” DEPOSIT CHECKER -->
<div class="section" style="background:#101010;">
  <h3>ğŸ” Check Your Deposit Status</h3>
  <p>Enter your <b>Deposit Hash</b> to see amount, date, and status (plus countdown timer).</p>
  <input id="checkHash" placeholder="Deposit Hash (0xâ€¦)" /><br/>
  <button id="checkBtn">ğŸ” Check Status</button>
  <div id="checkResult" style="margin-top:1rem;color:#00ff99;font-family:monospace;"></div>
  <small>Works even without wallet connection.</small>
</div>
<!-- ğŸ“˜ HOW IT WORKS -->
<div class="section" style="background:#131313;">
  <h3>ğŸ“˜ How It Works â€” Step by Step</h3>
  <ol style="text-align:left;line-height:1.6em;">
    <li><b>Generate Secret & Hash</b> â€” Tap the green button in the Shield section.</li>
    <li><b>Deposit PRIVX</b> â€” Enter amount, approve once, then deposit.</li>
    <li><b>Commit</b> â€” Paste Secret + fresh wallet in Withdrawer section â†’ generate Commit Hash â†’ commit.</li>
    <li><b>Withdraw</b> â€” Wait a few minutes after commit, then reveal your secret.</li>
    <li><b>Reclaim</b> â€” After 7 days anyone can reclaim if forgotten (95 % burn / 5 % reward).</li>
    <li><b>Check</b> â€” Verify any deposit on-chain by its hash.</li>
  </ol>
  <h3>ğŸ§­ Best Practices</h3>
  <ul style="text-align:left;line-height:1.6em;">
    <li>ğŸª™ <b>Backup your Secret.</b> Lose it = lose access.</li>
    <li>ğŸ” <b>Keep your Secret private.</b> Anyone with it can withdraw within 7 days.</li>
    <li>ğŸ•¶ï¸ <b>Always Commit before Withdraw.</b> Prevents front running withdrawals.</li>
    <li>ğŸ•“ <b>Respect the 7-day window.</b> Withdraw on time or funds become claimable.</li>
    <li>ğŸ”¥ <b>Expired deposits are burned.</b> 95 % destroyed â€¢ 5 % rewarded â€¢ no middlemen.</li>
    <li>âš™ï¸ <b>Verify contract addresses.</b> Use only official PRIVX and Shield Relay CAs.</li>
    <li>ğŸ§© <b>More users = more privacy.</b> Each deposit adds noise and protection.</li>
    <li>âš ï¸ Do NOT send more than you can afford to lose.</li>
  </ul>
  <blockquote style="border-left:3px solid #8b5cf6;padding-left:1rem;margin:1rem 0;color:#ccc;">
    â€œThe 7-day window forms the privacy horizon. The commit hides your step. The reveal completes your path unseen.â€
  </blockquote>
  <p style="color:#8b5cf6;font-weight:bold;margin-top:1rem;">â€œThe more we walk together, the harder we are to follow.â€</p>
  <p style="color:#00ffcc;">PrivX â€” Privacy by participation. Strength in numbers.</p>
</div>
<footer>
  <hr>
  <p>PulseChain Native â€¢ MIT License â€¢ Open Source</p>
  <p><a href="https://github.com/elitev5/PrivX" target="_blank" rel="noopener noreferrer">View Source on GitHub</a></p>
  <p style="margin-top:1rem;color:#8b5cf6;font-weight:bold;">â€œWe donâ€™t hide. We outnumber.â€</p>
</footer>
<script>
/* ---------- COPY ADDRESS BUTTON ---------- */
function copyCA(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.textContent.trim();
  if (!text.startsWith("0x")) return;
  navigator.clipboard.writeText(text).then(() => {
    const btn = el.nextElementSibling;
    if (!btn) return;
    const original = btn.textContent;
    btn.textContent = "âœ… Copied!";
    btn.style.background = "#00ff99";
    btn.style.color = "#000";
    setTimeout(() => {
      btn.textContent = original;
      btn.style.background = "#333";
      btn.style.color = "#00ffcc";
    }, 1000);
  });
}
/* ---------- CONTRACT CONSTANTS ---------- */
const relayAddress = "0x2F7fc6d09A9A3a5766CF06386c92a099351c64B6";
const mintVaultAddr = "0x8Cfd5090fab215Fb4aE5ef01EDD5D64baCd4B5fB";
const tokenAddress = "0x34310B5d3a8d1e5f8e4A40dcf38E48d90170E986";
const PULSECHAIN_ID = "0x171"; // chainId 369
let provider, signer, account, contract, privx;
/* ---------- CONNECT WALLET ---------- */
async function connect() {
  if (!window.ethereum) return alert("No wallet found.");
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  const chainId = await provider.send("eth_chainId", []);
  if (chainId !== PULSECHAIN_ID) {
    alert("Switch to PulseChain (369)");
    return;
  }
  document.getElementById("status").textContent = "âœ… " + account.slice(0, 6) + "â€¦" + account.slice(-4);
  document.getElementById("status").style.color = "#00ff99";
  document.getElementById("disconnect").style.display = "inline-block";
  ["approveBtn", "depositBtn", "withdrawBtn", "reclaimBtn", "commitBtn"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = false;
  });
  const abi = await fetch("./abi.json").then(r => r.json());
  contract = new ethers.Contract(relayAddress, abi, signer);
  privx = new ethers.Contract(
    tokenAddress,
    [
      "function approve(address,uint256) external returns(bool)",
      "function allowance(address,address) view returns(uint256)",
      "function balanceOf(address) view returns(uint256)",
      "function decimals() view returns(uint8)"
    ],
    signer
  );
  provider.on("accountsChanged", () => location.reload());
  provider.on("chainChanged", () => location.reload());
}
function disconnect() {
  provider = signer = account = null;
  document.getElementById("status").textContent = "âŒ Disconnected";
  ["approveBtn", "depositBtn", "withdrawBtn", "reclaimBtn", "commitBtn"].forEach(id => {
    const el = document.getElementById(id); if (el) el.disabled = true;
  });
}
/* ---------- PUBLIC PROVIDERS ---------- */
const pubProv = new ethers.providers.JsonRpcProvider("https://rpc.pulsechain.com");
const mintVaultAbi = [
  "function totalDistributed() view returns(uint256)",
  "function remainingRewards() view returns(uint256)",
  "function decayFactor() view returns(uint256)",
  "function isSealed() view returns(bool)"
];
const mintVault = new ethers.Contract(mintVaultAddr, mintVaultAbi, pubProv);
/* ---------- UPDATE MINING VAULT ---------- */
async function updateMiningVault() {
  try {
    const [d, r, dec, sealed] = await Promise.all([
      mintVault.totalDistributed(),
      mintVault.remainingRewards(),
      mintVault.decayFactor(),
      mintVault.isSealed()
    ]);
    document.getElementById("vaultDistributed").textContent = ethers.utils.formatUnits(d, 18) + " PRIVX";
    document.getElementById("vaultRemaining").textContent = ethers.utils.formatUnits(r, 18) + " PRIVX";
    document.getElementById("vaultDecay").textContent = dec.toString();
    document.getElementById("vaultSealed").textContent = sealed ? "ğŸ”’ Sealed" : "ğŸŸ¢ Active";
  } catch (e) { console.warn("Vault update err:", e); }
}
/* ---------- RELAY DASHBOARD ---------- */
(async () => {
  const abi = await fetch("./abi.json").then(r => r.json());
  const pubContract = new ethers.Contract(relayAddress, abi, pubProv);
  ["approveBtn","depositBtn","withdrawBtn","reclaimBtn","commitBtn"].forEach(id => {
    const el = document.getElementById(id); if (el) el.disabled = true;
  });
  async function updateVaultBalance() {
    try {
      const b = await pubContract.totalVaultBalance();
      let val = Number(ethers.utils.formatUnits(b, 18));
      if (val < 1) val = 0;
      document.getElementById("vaultBalance").textContent = val.toFixed(2) + " PRIVX";
      document.getElementById("vaultUpdate").textContent = "âœ… Updated " + new Date().toLocaleTimeString();
    } catch {
      document.getElementById("vaultBalance").textContent = "Error";
    }
  }
  async function updateBurnCounter() {
    try {
      const [relayBurned, vaultTotalDist] = await Promise.all([
        pubContract.totalBurned(),
        mintVault.totalDistributed()
      ]);
      const vaultBurned = vaultTotalDist.mul(30).div(100);
      const total = relayBurned.add(vaultBurned);
      const val = Number(ethers.utils.formatUnits(total, 18));
      const display = val < 1 ? 0 : val.toFixed(2);
      document.getElementById("burnCounter").textContent = `${display} PRIVX ğŸ”¥`;
      document.getElementById("burnUpdate").textContent = "âœ… Updated " + new Date().toLocaleTimeString();
    } catch (e) {
      console.warn("Burn counter update failed:", e);
      document.getElementById("burnCounter").textContent = "Error";
    }
  }
  async function updateShieldStrength() {
    try {
      const [vaultBal, burned, reclaimed, withdrawals, totalDist, remainingRewards] = await Promise.all([
        pubContract.totalVaultBalance(),
        pubContract.totalBurned(),
        pubContract.totalReclaimed(),
        pubContract.totalWithdrawals(),
        mintVault.totalDistributed(),
        mintVault.remainingRewards()
      ]);
      const v = Number(ethers.utils.formatUnits(vaultBal, 18));
      const b = Number(ethers.utils.formatUnits(burned, 18));
      const r = Number(ethers.utils.formatUnits(reclaimed, 18));
      const w = Number(withdrawals);
      const d = Number(ethers.utils.formatUnits(totalDist, 18));
      const rem = Number(ethers.utils.formatUnits(remainingRewards, 18));
      const activeRatio = Math.min(v / (v + b + d + 1), 1);
      const burnRatio = Math.min(b / (v + b + d + 1), 1);
      const rewardActivity = Math.min(d / (d + rem + 1), 1);
      const rewardReserve = Math.min(rem / 2_100_000, 1);
      const usage = Math.min((r + w) / 1000, 1);
      let score = activeRatio * 35 + burnRatio * 15 + rewardActivity * 25 + rewardReserve * 15 + usage * 10;
      if (v < 1000) score += 20;
      else if (v < 5000) score += 10;
      if (d < 100) score += 10;
      if (score > 100) score = 100;
      let label, color;
      if (score >= 70) { label = "ğŸŸ¢ Optimized"; color = "#00ff99"; }
      else if (score >= 45) { label = "ğŸŸ¡ Stabilizing"; color = "#ffcc00"; }
      else { label = "ğŸ”´ Weak"; color = "#ff6666"; }
      const el = document.getElementById("networkActivity");
      el.innerHTML = `${score.toFixed(1)}% Shield Strength<br><small>${label}</small>`;
      el.style.color = color;
      document.getElementById("networkUpdate").textContent = "âœ… Updated " + new Date().toLocaleTimeString();
    } catch (e) {
      console.warn("Shield strength update error:", e);
      document.getElementById("networkActivity").textContent = "âš ï¸ Error reading shield metrics";
    }
  }
  async function updateTopDeposits() {
    const el = document.getElementById("topDeposits");
    el.textContent = "â³ Loading recent deposit data...";
    try {
      const filter = pubContract.filters.Deposited();
      const events = await pubContract.queryFilter(filter, -100000);
      if (!events || events.length === 0) {
        el.textContent = "No recent deposits found.";
        return;
      }
      const counts = {};
      for (const e of events) {
        const amt = Number(ethers.utils.formatUnits(e.args.amount, 18));
        const exact = amt.toFixed(2);
        counts[exact] = (counts[exact] || 0) + 1;
      }
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
      el.innerHTML = sorted.map(([amt, count], idx) =>
        `<div>ğŸ… <b>#${idx + 1}</b> â€” <span style="color:#00ffcc;">${amt}</span> PRIVX &nbsp;(${count} deposits)</div>`
      ).join("<br>");
      el.insertAdjacentHTML("beforeend", `<br><small style="color:#777;">âœ… Updated ${new Date().toLocaleTimeString()}</small>`);
    } catch (err) {
      console.warn("Top deposits error:", err);
      el.textContent = "âš ï¸ Unable to load data.";
    }
  }
  async function ensurePulse() {
    const c = await window.ethereum.request({method:"eth_chainId"});
    if (c !== PULSECHAIN_ID) { alert("Switch to PulseChain"); return false; }
    return true;
  }
  /* ---------- BUTTON ACTIONS ---------- */
  document.getElementById("connect").onclick = connect;
  document.getElementById("disconnect").onclick = disconnect;
  document.getElementById("approveBtn").onclick = async () => {
    try {
      const tx = await privx.approve(relayAddress, ethers.constants.MaxUint256);
      alert("âœ… Approval TX " + tx.hash);
    } catch (e) { alert("Approval failed: " + e.message); }
  };
  document.getElementById("depositBtn").onclick = async () => {
    const amt = document.getElementById("depositAmount").value.trim();
    const h = document.getElementById("depositHash").value.trim();
    if (!amt || !h) return alert("Enter amount & hash");
    if (!await ensurePulse()) return;
    try {
      const v = ethers.utils.parseUnits(amt, 18);
      const allow = await privx.allowance(account, relayAddress);
      if (allow.lt(v)) return alert("Approve PRIVX first");
      const tx = await contract.deposit(v, h);
      alert("ğŸ’° Deposit TX: " + tx.hash);
    } catch (e) { alert("Deposit failed: " + e.message); }
  };
  document.getElementById("commitBtn").onclick = async () => {
    const cHash = document.getElementById("commitHashInput").value.trim();
    if (!/^0x([A-Fa-f0-9]{64})$/.test(cHash)) return alert("Invalid hash");
    if (!await ensurePulse()) return;
    try {
      const tx = await contract.commit(cHash);
      alert("ğŸ•¶ï¸ Commit TX: " + tx.hash);
    } catch (e) { alert("Commit failed: " + e.message); }
  };
  document.getElementById("withdrawBtn").onclick = async () => {
    const s = document.getElementById("withdrawSecret").value.trim();
    const addrs = ["wallet1","wallet2","wallet3"].map(i => document.getElementById(i).value.trim()).filter(a => ethers.utils.isAddress(a));
    if (!s || !addrs.length) return alert("Enter secret & at least one wallet");
    if (!await ensurePulse()) return;
    try {
      const tx = await contract.withdraw(s, addrs);
      alert("ğŸ’ Withdraw TX: " + tx.hash);
    } catch (e) { alert("Withdraw failed: " + e.message); }
  };
  document.getElementById("reclaimBtn").onclick = async () => {
    const h = document.getElementById("reclaimHash").value.trim();
    if (!h) return alert("Enter deposit hash");
    if (!await ensurePulse()) return;
    try {
      const tx = await contract.reclaim(h);
      alert("ğŸ”¥ Reclaim TX: " + tx.hash);
    } catch (e) { alert("Reclaim failed: " + e.message); }
  };
  document.getElementById("loadReclaimable").onclick = () => {
    document.getElementById("reclaimList").textContent = "â³ Reading on-chain events (not available in static mode)";
  };
  document.getElementById("checkBtn").onclick = async function checkDepositStatus() {
    const hash = document.getElementById("checkHash").value.trim();
    if (!hash) return alert("Enter a valid deposit hash first.");
    const out = document.getElementById("checkResult");
    out.textContent = "â³ Checking on-chain statusâ€¦";
    try {
      const d = await pubContract.deposits(hash);
      if (!d || d.amount.eq(0)) {
        out.innerHTML = "âŒ No deposit found for this hash.";
        return;
      }
      const amount = ethers.utils.formatUnits(d.amount, 18);
      const ts = Number(d.timestamp);
      const claimed = d.claimed;
      const depositDate = new Date(ts > 1e12 ? ts : ts * 1000);
      const expiry = depositDate.getTime() + 7 * 24 * 60 * 60 * 1000;
      out.innerHTML = `
        <div style="color:${claimed ? "#00ff99" : "#00ffcc"}">
          <b>Status:</b> ${claimed ? "âœ… Claimed / Withdrawn" : "ğŸŸ£ Active"}<br>
          <b>Amount:</b> ${amount} PRIVX<br>
          <b>Deposited:</b> ${depositDate.toLocaleString()}<br>
          <b>Expires:</b> ${new Date(expiry).toLocaleString()}<br>
          <div id="countdown" style="color:#ffcc00;margin-top:0.5rem;"></div>
        </div>`;
      if (!claimed) {
        const countdownEl = document.getElementById("countdown");
        const tick = () => {
          const remaining = expiry - Date.now();
          if (remaining <= 0) {
            countdownEl.innerHTML = "<b>ğŸ”¥ Expired â€” Reclaimable</b>";
            countdownEl.style.color = "#ff6600";
            return;
          }
          const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
          const hrs = Math.floor((remaining / (1000 * 60 * 60)) % 24);
          const mins = Math.floor((remaining / (1000 * 60)) % 60);
          const secs = Math.floor((remaining / 1000) % 60);
          countdownEl.innerHTML = `<b>â± Time remaining:</b> ${days}d ${hrs}h ${mins}m ${secs}s`;
          setInterval(tick, 1000);
        };
        tick();
      }
    } catch (e) {
      out.textContent = "âŒ Error: " + e.message;
    }
  };
  async function refreshAll() {
    try {
      await updateVaultBalance();
      await updateBurnCounter();
      await updateMiningVault();
      await updateShieldStrength();
      await updateTopDeposits();
    } catch (e) {
      console.warn("refreshAll error:", e);
    }
  }
  refreshAll();
  setInterval(refreshAll, 30000);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// â€”â€”â€” FINAL: QR CODE + PRIVX LOGO + SAVE + WARNING â€”â€”â€”
let currentSecret = "";
let currentDepositHash = "";

document.getElementById("autoGenerate").onclick = () => {
  if (currentSecret && !confirm("âš ï¸ Generate new secret?\nYour current one will be lost forever if not saved!")) {
    return;
  }

  const bytes = crypto.getRandomValues(new Uint8Array(32));
  currentSecret = Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
  document.getElementById("masterSecret").value = currentSecret;

  const encoded = ethers.utils.defaultAbiCoder.encode(["string"], [currentSecret]);
  currentDepositHash = ethers.utils.keccak256(encoded);
  document.getElementById("liveDepositHash").textContent = currentDepositHash;
  document.getElementById("depositHash").value = currentDepositHash;

  // Generate QR Code with embedded PRIVX logo
  const qrText = `PRIVX SECRET\n${currentSecret}\n\nDeposit Hash: ${currentDepositHash}`;
  QRCode.toCanvas(document.getElementById("qrCanvas"), qrText, { width: 280, margin: 2 }, (error) => {
    if (error) console.error(error);
  });

  // Show QR + enable buttons + warning
  document.getElementById("qrContainer").style.display = "block";
  document.getElementById("qrHint").style.display = "block";
  document.getElementById("saveSecretBtn").disabled = false;
  document.getElementById("copySecretBtn").disabled = false;
  document.getElementById("saveQRBtn").disabled = false;
  document.getElementById("unsavedWarning").style.display = "block";

  alert("Generated! â†’ Save QR or .txt â†’ Send to friend!");
};

// Save as .txt
document.getElementById("saveSecretBtn").onclick = () => {
  const text = `PRIVX SHIELD - SECRET\n\nSecret: ${currentSecret}\nDeposit Hash: ${currentDepositHash}\nGenerated: ${new Date().toLocaleString()}`;
  const blob = new Blob([text], {type: "text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `PrivX-Secret-${currentSecret.slice(0,10)}.txt`;
  a.click();
  document.getElementById("unsavedWarning").style.display = "none";
};

// Copy to clipboard
document.getElementById("copySecretBtn").onclick = async () => {
  await navigator.clipboard.writeText(`Secret: ${currentSecret}\nHash: ${currentDepositHash}`);
  alert("Copied!");
  document.getElementById("unsavedWarning").style.display = "none";
};

// Save QR Code as PNG
document.getElementById("saveQRBtn").onclick = () => {
  const canvas = document.getElementById("qrCanvas");
  const logoCanvas = document.createElement("canvas");
  logoCanvas.width = canvas.width;
  logoCanvas.height = canvas.height;
  const ctx = logoCanvas.getContext("2d");
  ctx.drawImage(canvas, 0, 0);
  ctx.drawImage(document.getElementById("qrLogo"), canvas.width/2 - 32, canvas.height/2 - 32, 64, 64);

  logoCanvas.toBlob(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `PrivX-Secret-QR-${currentSecret.slice(0,10)}.png`;
    a.click();
  });
  document.getElementById("unsavedWarning").style.display = "none";
  alert("QR Code saved with PRIVX logo!");
};

// Withdrawer unchanged
document.getElementById("generateCommit").onclick = () => {
  const secret = document.getElementById("withdrawSecret").value.trim();
  const wallet = document.getElementById("withdrawWallet").value.trim();
  if (!secret) return alert("Paste the Secret first");
  if (!ethers.utils.isAddress(wallet)) return alert("Invalid wallet address");
  const packed = ethers.utils.solidityPack(["string", "address"], [secret, wallet]);
  const commitHash = ethers.utils.keccak256(packed);
  document.getElementById("commitHashInput").value = commitHash;
  document.getElementById("wallet1").value = wallet;
  alert("Commit Hash generated!\nâ†’ Commit now â†’ Wait 5 mins â†’ Withdraw");
};
</script>
</body>
</html>
