// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

// Poseidon T3 PrivX
library PoseidonT3 {
    uint256 constant q = 21888242871839275222246405745257275088548364400416034343698204186575808495617;

    function hash(uint256[2] memory input) internal pure returns (uint256) {
        uint256 x = input[0] % q;
        uint256 y = input[1] % q;

        // === 8 full rounds (4 before, 4 after partials) ===
        x = (x + 12861791851186454756856465657750459816989389089376497637901611881939633773556 + y) % q;
        y = (y + 12861791851186454756856465657750459816989389089376497637901611881939633773556 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 5519671076407899149475471873582650243950107592374834593479994102631768852387 + y) % q;
        y = (y + 5519671076407899149475471873582650243950107592374834593479994102631768852387 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 10832496908481223032496354855685040477446072176891917826424127680329380157411 + y) % q;
        y = (y + 10832496908481223032496354855685040477446072176891917826424127680329380157411 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 197023341468610140031081920968023783964819417505440696127650404864701462882 + y) % q;
        y = (y + 197023341468610140031081920968023783964819417505440696127650404864701462882 + x) % q;
        x = pow5(x);
        y = pow5(y);

        // === 56 partial rounds (only x is updated) ===
        for (uint256 i = 0; i < 56; i++) {
            x = (x + 182251860366398770052311923749666265525174614955508549662173528391496234720) % q; // this is the real C
            x = pow5(x);
            x = (x + mulmod(91125930183199385026155961874833132762587307477754274831086764195748117360, y, q)) % q; // this is the real M
        }

        // === last 4 full rounds ===
        x = (x + 133961901813997148524200689039311302035210029358159615165091333675391005 + y) % q;
        y = (y + 133961901813997148524200689039311302035210029358159615165091333675391005 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 21526503533429280966392593094949932105722060737862572179582474350057866930688 + y) % q;
        y = (y + 21526503533429280966392593094949932105722060737862572179582474350057866930688 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 22616005108334998208888373407539051456988600368523 + y) % q;
        y = (y + 22616005108334998208888373407539051456988600368523 + x) % q;
        x = pow5(x);
        y = pow5(y);

        x = (x + 138521903175307636434294058242398758941602410109806 + y) % q;
        y = (y + 138521903175307636434294058242398758941602410109806 + x) % q;
        x = pow5(x);
        y = pow5(y);

        return x;
    }

    function pow5(uint256 x) internal pure returns (uint256) {
        uint256 x2 = mulmod(x, x, q);
        uint256 x4 = mulmod(x2, x2, q);
        return mulmod(x4, x, q);
    }
}

contract Hasher {
    function hash(uint256 left, uint256 right) external pure returns (bytes32) {
        uint256[2] memory input;
        input[0] = left;
        input[1] = right;
        return bytes32(PoseidonT3.hash(input));
    }
}